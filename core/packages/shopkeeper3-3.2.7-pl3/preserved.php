<?php return array (
  'f716996b9eba4904f0ab53a0c156ac1b' => 
  array (
    'criteria' => 
    array (
      'name' => 'shopkeeper3',
    ),
    'object' => 
    array (
      'name' => 'shopkeeper3',
      'path' => '{core_path}components/shopkeeper3/',
      'assets_path' => '{assets_path}components/shopkeeper3/',
    ),
  ),
  'fc85a8d8a15dfddec4084ae45db52792' => 
  array (
    'criteria' => 
    array (
      'text' => 'shopkeeper3',
    ),
    'object' => 
    array (
      'text' => 'shopkeeper3',
      'parent' => 'components',
      'action' => 'index',
      'description' => 'shk3.menu_desc',
      'icon' => '',
      'menuindex' => 0,
      'params' => '',
      'handler' => '',
      'permissions' => '',
      'namespace' => 'shopkeeper3',
    ),
  ),
  '0766fde3105bf57647f113275803ca82' => 
  array (
    'criteria' => 
    array (
      'key' => 'shk3.property_sets',
    ),
    'object' => 
    array (
      'key' => 'shk3.property_sets',
      'value' => 'cart_catalog,cart_order_page',
      'xtype' => 'textfield',
      'namespace' => 'shopkeeper3',
      'area' => '',
      'editedon' => NULL,
    ),
  ),
  '64e230a706462f06b91545c9c939c2da' => 
  array (
    'criteria' => 
    array (
      'key' => 'shk3.currency',
    ),
    'object' => 
    array (
      'key' => 'shk3.currency',
      'value' => 'руб.',
      'xtype' => 'textfield',
      'namespace' => 'shopkeeper3',
      'area' => '',
      'editedon' => NULL,
    ),
  ),
  '51051193bcdeb92c99595c049bbc9421' => 
  array (
    'criteria' => 
    array (
      'key' => 'shk3.currency_default',
    ),
    'object' => 
    array (
      'key' => 'shk3.currency_default',
      'value' => '1',
      'xtype' => 'textfield',
      'namespace' => 'shopkeeper3',
      'area' => '',
      'editedon' => NULL,
    ),
  ),
  'c223b15ad6d869206a1b4aafe2ac8af3' => 
  array (
    'criteria' => 
    array (
      'key' => 'shk3.mail_order_data_tpl',
    ),
    'object' => 
    array (
      'key' => 'shk3.mail_order_data_tpl',
      'value' => 'orderDataOuter',
      'xtype' => 'textfield',
      'namespace' => 'shopkeeper3',
      'area' => '',
      'editedon' => NULL,
    ),
  ),
  'b5c69080ad4f21a7a3aaa2baa0b46da5' => 
  array (
    'criteria' => 
    array (
      'key' => 'shk3.mail_order_data_row_tpl',
    ),
    'object' => 
    array (
      'key' => 'shk3.mail_order_data_row_tpl',
      'value' => 'orderDataRow',
      'xtype' => 'textfield',
      'namespace' => 'shopkeeper3',
      'area' => '',
      'editedon' => NULL,
    ),
  ),
  'e44225ce1e28d1255b6c5d03c305e4c0' => 
  array (
    'criteria' => 
    array (
      'key' => 'shk3.mail_contacts_row_tpl',
    ),
    'object' => 
    array (
      'key' => 'shk3.mail_contacts_row_tpl',
      'value' => 'mailContactsRow',
      'xtype' => 'textfield',
      'namespace' => 'shopkeeper3',
      'area' => '',
      'editedon' => NULL,
    ),
  ),
  '75c87996099be11efb757b9e2c5a6883' => 
  array (
    'criteria' => 
    array (
      'key' => 'shk3.first_status',
    ),
    'object' => 
    array (
      'key' => 'shk3.first_status',
      'value' => '1',
      'xtype' => 'textfield',
      'namespace' => 'shopkeeper3',
      'area' => '',
      'editedon' => NULL,
    ),
  ),
  '726ec61a91abab0e8a5a22b76e4c1b2a' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKaddProduct',
    ),
    'object' => 
    array (
      'name' => 'OnSHKaddProduct',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'a78320fa9fdbfd2d14ff0fb604827a3d' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKgetProductPrice',
    ),
    'object' => 
    array (
      'name' => 'OnSHKgetProductPrice',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '1c6ca4910de01da0b62bb531810d5341' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKcalcTotalPrice',
    ),
    'object' => 
    array (
      'name' => 'OnSHKcalcTotalPrice',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'a8f9a6359738175cc2925c105075257d' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKcartLoad',
    ),
    'object' => 
    array (
      'name' => 'OnSHKcartLoad',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'bc5b1e0e2aa18868f02f93029b6cc7ea' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKChangeStatus',
    ),
    'object' => 
    array (
      'name' => 'OnSHKChangeStatus',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '8bad545ca941ec68895d863b88974615' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKsaveOrder',
    ),
    'object' => 
    array (
      'name' => 'OnSHKsaveOrder',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'bfea1c6d59e4ff276e53324aa8c14ea8' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKbeforeCartLoad',
    ),
    'object' => 
    array (
      'name' => 'OnSHKbeforeCartLoad',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '43a8730251e84e7823db523d1cb704b6' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKScriptsLoad',
    ),
    'object' => 
    array (
      'name' => 'OnSHKScriptsLoad',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '0281ffe6ecde60dc0d78581750c1d5f8' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKsendOrderMail',
    ),
    'object' => 
    array (
      'name' => 'OnSHKsendOrderMail',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'e4f5012a974db83617c02a5536b4df3e' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKAfterAddProduct',
    ),
    'object' => 
    array (
      'name' => 'OnSHKAfterAddProduct',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '7381a4ccf85849e6c0403772b8ced976' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKgetProductAdditParams',
    ),
    'object' => 
    array (
      'name' => 'OnSHKgetProductAdditParams',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'd7813ea1c7163f7fe5c4cba92352c6cc' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKcalcTotaQuantity',
    ),
    'object' => 
    array (
      'name' => 'OnSHKcalcTotaQuantity',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'd093453040b6eda5dd5c4d00e221e970' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKgetProductAdditParamPrice',
    ),
    'object' => 
    array (
      'name' => 'OnSHKgetProductAdditParamPrice',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '78a2fe505bdbb9be2734ea0ca583d18a' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKprintOrderData',
    ),
    'object' => 
    array (
      'name' => 'OnSHKprintOrderData',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'e2b5c7053bfb2e04ac68455114f4e734' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKgetDeliveryPrice',
    ),
    'object' => 
    array (
      'name' => 'OnSHKgetDeliveryPrice',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '5bec9178528dc9b6f1a08ff992e4db6c' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKafterAddProduct',
    ),
    'object' => 
    array (
      'name' => 'OnSHKAfterAddProduct',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '473e1e2655fdd7ba37df70283e4045f0' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKAfterRemoveProduct',
    ),
    'object' => 
    array (
      'name' => 'OnSHKAfterRemoveProduct',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  '4808bc63c56843981bab0dd03ab5b921' => 
  array (
    'criteria' => 
    array (
      'name' => 'OnSHKAfterClearCart',
    ),
    'object' => 
    array (
      'name' => 'OnSHKAfterClearCart',
      'service' => 6,
      'groupname' => 'Shopkeeper3',
    ),
  ),
  'b2a914fbd841fb22a90604cc850a828c' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk3.widget_name',
    ),
    'object' => 
    array (
      'id' => 6,
      'name' => 'shk3.widget_name',
      'description' => 'shk3.widget_desc',
      'type' => 'file',
      'content' => '[[++core_path]]components/shopkeeper3/elements/widgets/widget.shk_stat.php',
      'namespace' => 'shopkeeper3',
      'lexicon' => 'shopkeeper3:manager',
      'size' => 'full',
      'name_trans' => 'Статистика заказов',
      'description_trans' => 'Статистика заказов в интернет-магазине',
    ),
  ),
  '34c154956b620df27411591cd4b19384' => 
  array (
    'criteria' => 
    array (
      'category' => 'Shopkeeper3',
    ),
    'object' => 
    array (
      'id' => 3,
      'parent' => 0,
      'category' => 'Shopkeeper3',
      'rank' => 0,
    ),
  ),
  '217cf576578a94a8070cbf1f977ddbd7' => 
  array (
    'criteria' => 
    array (
      'name' => 'shopCartRow',
    ),
    'object' => 
    array (
      'id' => 5,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shopCartRow',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '<tr class="cart-order">
    <td align="left"><b><a href="[[+url]]">[[+name]]</a></b> [[+addit_data]]</td>
    <td>[[+price]] [[+currency]]</td>
    <td>
        <input class="shk-count" type="text" size="2" name="count[]" maxlength="3" title="изменить количество" value="[[+count]]" />
    </td>
    <td align="right">
        <a href="[[+url_del_item]]" title="Удалить" class="shk-del"><img src="assets/components/shopkeeper3/web/css/default/delete.gif" width="17" height="17" alt="Удалить" /></a>
    </td>
</tr>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '<tr class="cart-order">
    <td align="left"><b><a href="[[+url]]">[[+name]]</a></b> [[+addit_data]]</td>
    <td>[[+price]] [[+currency]]</td>
    <td>
        <input class="shk-count" type="text" size="2" name="count[]" maxlength="3" title="изменить количество" value="[[+count]]" />
    </td>
    <td align="right">
        <a href="[[+url_del_item]]" title="Удалить" class="shk-del"><img src="assets/components/shopkeeper3/web/css/default/delete.gif" width="17" height="17" alt="Удалить" /></a>
    </td>
</tr>',
    ),
  ),
  '00438bbcc2a9b197c828c911ef9de9f0' => 
  array (
    'criteria' => 
    array (
      'name' => 'shopCart',
    ),
    'object' => 
    array (
      'id' => 6,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shopCart',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '<div class="shop-cart" data-shopcart="2">
    <div class="shop-cart-head"><b>Корзина</b></div>
    <div class="empty">
        <div class="shop-cart-empty">Пусто</div>
    </div>
</div>
<!--tpl_separator-->
<div class="shop-cart" data-shopcart="2">
    <div class="shop-cart-head"><a name="shopCart"></a><b>Корзина</b></div>
    <div class="full">
        <form action="[[+this_page_url]]#shopCart" method="post">
        <fieldset>
            <div  style="text-align:right;">
                <a href="[[+empty_url]]" id="shk_butEmptyCart">Очистить корзину</a>
            </div>
            <table width="100%">
                <colgroup>
                    <col width="40%" />
                    <col width="25%" />
                    <col width="25%" />
                    <col width="10%" />
                </colgroup>
                <tbody>
                    [[+inner]]
                </tbody>
            </table>
            <div  style="text-align:right;">
                Доставка: [[+delivery_name]] ([[+delivery_price]] [[+currency]])
            </div>
            <div  style="text-align:right;">
                Общая сумма: <b>[[+price_total]]</b> [[+currency]]
            </div>
            <noscript>
                <div><input type="submit" name="shk_recount" value="Пересчитать" /></div>
            </noscript>
            <div class="cart-order">
                <a href="[[+order_page_url]]" id="shk_butOrder">Оформить заказ</a>
            </div>
        </fieldset>
        </form>
    </div>
</div>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '<div class="shop-cart" data-shopcart="2">
    <div class="shop-cart-head"><b>Корзина</b></div>
    <div class="empty">
        <div class="shop-cart-empty">Пусто</div>
    </div>
</div>
<!--tpl_separator-->
<div class="shop-cart" data-shopcart="2">
    <div class="shop-cart-head"><a name="shopCart"></a><b>Корзина</b></div>
    <div class="full">
        <form action="[[+this_page_url]]#shopCart" method="post">
        <fieldset>
            <div  style="text-align:right;">
                <a href="[[+empty_url]]" id="shk_butEmptyCart">Очистить корзину</a>
            </div>
            <table width="100%">
                <colgroup>
                    <col width="40%" />
                    <col width="25%" />
                    <col width="25%" />
                    <col width="10%" />
                </colgroup>
                <tbody>
                    [[+inner]]
                </tbody>
            </table>
            <div  style="text-align:right;">
                Доставка: [[+delivery_name]] ([[+delivery_price]] [[+currency]])
            </div>
            <div  style="text-align:right;">
                Общая сумма: <b>[[+price_total]]</b> [[+currency]]
            </div>
            <noscript>
                <div><input type="submit" name="shk_recount" value="Пересчитать" /></div>
            </noscript>
            <div class="cart-order">
                <a href="[[+order_page_url]]" id="shk_butOrder">Оформить заказ</a>
            </div>
        </fieldset>
        </form>
    </div>
</div>',
    ),
  ),
  '3780019f0b1975b5f0a1e17471adb5d4' => 
  array (
    'criteria' => 
    array (
      'name' => 'shopOrderForm',
    ),
    'object' => 
    array (
      'id' => 7,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shopOrderForm',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '[[!shkOptions?
&get=`delivery,payments`
&post_name=`shk_delivery,payment`
&toPlaceholders=`1`
&pl_prefix=`shkopt_`
&tpl=`select_option`
]]

<p class="error">[[!+fi.error.error_message]]</p>
<br />

<form method="post" action="[[~[[*id]]]]" id="shopOrderForm">

<fieldset>

<input type="text" name="nospam:blank" value="" style="display:none;" />
<input type="hidden" name="order" value="1" />

<table cellpadding="3">
    <tr>
        <td>Ф.И.О.*:</td>
        <td>
            <input name="fullname" size="30" class="textfield" type="text" value="[[!+fi.fullname:default=`[[+modx.user.id:userinfo=`fullname`]]`:ne=`0`:show]]" />
            <div>[[!+fi.error.fullname]]</div>
        </td>
    </tr>
    <tr>
        <td>Адрес*:</td>
        <td>
              <input name="address" size="30" class="textfield" type="text" value="[[!+fi.address:default=`[[+modx.user.id:userinfo=`address`]]`:ne=`0`:show]]" />
              <div>[[!+fi.error.address]]</div>
        </td>
    </tr>
    <tr>
        <td>E-mail*:</td>
        <td>
            <input name="email" size="30" class="textfield" type="text" value="[[!+fi.email:default=`[[+modx.user.id:userinfo=`email`]]`:ne=`0`:show]]" />
            <div>[[!+fi.error.email]]</div>
        </td>
    </tr>
    <tr>
        <td>Телефон*:</td>
        <td>
            <input name="phone" size="30" class="textfield" type="text" value="[[!+fi.phone:default=`[[+modx.user.id:userinfo=`phone`]]`:ne=`0`:show]]" />
            <div>[[!+fi.error.phone]]</div>
        </td>
    </tr>
    <tr>
        <td>Способ доставки*:</td>
        <td>
            <select name="shk_delivery" style="width:200px;">
                <option value=""></option>
                [[!+shkopt_delivery]]
            </select>
            <div>[[!+fi.error.shk_delivery]]</div>
        </td>
    </tr>
    <tr>
        <td>Способ оплаты*:</td>
        <td>
            <select name="payment" style="width:200px;">
                <option value=""></option>
                [[!+shkopt_payments]]
            </select>
            <div>[[!+fi.error.payment]]</div>
        </td>
    </tr>
    <tr>
        <td>Комментарий:</td>
        <td>
            <textarea name="message" class="textfield" rows="4" cols="30">[[!+fi.message]]</textarea>
        </td>
    </tr>
    <tr>
        <td></td>
        <td><input type="submit" name="submit_button" class="button" value="Отправить" /></td>
    </tr>
</table>

</fieldset>

</form>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '[[!shkOptions?
&get=`delivery,payments`
&post_name=`shk_delivery,payment`
&toPlaceholders=`1`
&pl_prefix=`shkopt_`
&tpl=`select_option`
]]

<p class="error">[[!+fi.error.error_message]]</p>
<br />

<form method="post" action="[[~[[*id]]]]" id="shopOrderForm">

<fieldset>

<input type="text" name="nospam:blank" value="" style="display:none;" />
<input type="hidden" name="order" value="1" />

<table cellpadding="3">
    <tr>
        <td>Ф.И.О.*:</td>
        <td>
            <input name="fullname" size="30" class="textfield" type="text" value="[[!+fi.fullname:default=`[[+modx.user.id:userinfo=`fullname`]]`:ne=`0`:show]]" />
            <div>[[!+fi.error.fullname]]</div>
        </td>
    </tr>
    <tr>
        <td>Адрес*:</td>
        <td>
              <input name="address" size="30" class="textfield" type="text" value="[[!+fi.address:default=`[[+modx.user.id:userinfo=`address`]]`:ne=`0`:show]]" />
              <div>[[!+fi.error.address]]</div>
        </td>
    </tr>
    <tr>
        <td>E-mail*:</td>
        <td>
            <input name="email" size="30" class="textfield" type="text" value="[[!+fi.email:default=`[[+modx.user.id:userinfo=`email`]]`:ne=`0`:show]]" />
            <div>[[!+fi.error.email]]</div>
        </td>
    </tr>
    <tr>
        <td>Телефон*:</td>
        <td>
            <input name="phone" size="30" class="textfield" type="text" value="[[!+fi.phone:default=`[[+modx.user.id:userinfo=`phone`]]`:ne=`0`:show]]" />
            <div>[[!+fi.error.phone]]</div>
        </td>
    </tr>
    <tr>
        <td>Способ доставки*:</td>
        <td>
            <select name="shk_delivery" style="width:200px;">
                <option value=""></option>
                [[!+shkopt_delivery]]
            </select>
            <div>[[!+fi.error.shk_delivery]]</div>
        </td>
    </tr>
    <tr>
        <td>Способ оплаты*:</td>
        <td>
            <select name="payment" style="width:200px;">
                <option value=""></option>
                [[!+shkopt_payments]]
            </select>
            <div>[[!+fi.error.payment]]</div>
        </td>
    </tr>
    <tr>
        <td>Комментарий:</td>
        <td>
            <textarea name="message" class="textfield" rows="4" cols="30">[[!+fi.message]]</textarea>
        </td>
    </tr>
    <tr>
        <td></td>
        <td><input type="submit" name="submit_button" class="button" value="Отправить" /></td>
    </tr>
</table>

</fieldset>

</form>',
    ),
  ),
  '63bf1cb2ed4bcd21746e7a4a091c9178' => 
  array (
    'criteria' => 
    array (
      'name' => 'shopOrderReport',
    ),
    'object' => 
    array (
      'id' => 8,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shopOrderReport',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '<!DOCTYPE html>
<html>

<head>
<style type="text/css">
body{background-color:#fff;}
table {width:650px; margin:10px 0; border:1px solid #BCBCBC; border-collapse:collapse;}
table td {padding:5px; border:1px solid #BCBCBC;}
</style>
</head>

<body>

<p><b>[[++site_name]]</b></p>

<p>В интернет-магазине сделан заказ.</p>

<div style="padding:15px 0; margin:15px 0; border-top:3px solid #BCBCBC; border-bottom:3px solid #BCBCBC;">

    <p>Номер заказа: [[+orderID]]</p>
    
    <p>Дата: [[+orderDate]].</p>
    
    [[+orderOutputData]]

</div>

<a href="[[++site_url]]" target="_blank">[[++site_url]]</a>

<br /><br />

</body>
</html>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '<!DOCTYPE html>
<html>

<head>
<style type="text/css">
body{background-color:#fff;}
table {width:650px; margin:10px 0; border:1px solid #BCBCBC; border-collapse:collapse;}
table td {padding:5px; border:1px solid #BCBCBC;}
</style>
</head>

<body>

<p><b>[[++site_name]]</b></p>

<p>В интернет-магазине сделан заказ.</p>

<div style="padding:15px 0; margin:15px 0; border-top:3px solid #BCBCBC; border-bottom:3px solid #BCBCBC;">

    <p>Номер заказа: [[+orderID]]</p>
    
    <p>Дата: [[+orderDate]].</p>
    
    [[+orderOutputData]]

</div>

<a href="[[++site_url]]" target="_blank">[[++site_url]]</a>

<br /><br />

</body>
</html>',
    ),
  ),
  '2cddf804aad582d9a96104c8e1ed41d6' => 
  array (
    'criteria' => 
    array (
      'name' => 'orderDataOuter',
    ),
    'object' => 
    array (
      'id' => 9,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'orderDataOuter',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '<p><b>Состав заказа</b></p>

<table>
    <thead>
        <tr class="active">
            <th>Наименование</th>
            <th>Параметры</th>
            <th>Кол-во, шт.</th>
            <th>Цена, [[+currency]]</th>
        </tr>
    </thead>
    <tbody>
        [[+purchases]]
    </tbody>
    <tfoot>
        <tr class="cart-order">
            <td colspan="3" style="text-align: right;">
                [[+delivery]]
            </td>
            <td>
                <b>[[+delivery_price:num_format]]</b>
            </td>
        </tr>
        <tr class="cart-order">
            <td colspan="3" style="text-align: right;">
                <b>Итого:</b>
            </td>
            <td>
                <b>[[+price:num_format]]</b>
            </td>
        </tr>
    </tfoot>
</table>

<p><b>Контактные данные</b></p>

<table>
    <colgroup>
        <col width="50%" span="2">
    </colgroup>
    <tbody>
        [[+contacts]]
    </tbody>
</table>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '<p><b>Состав заказа</b></p>

<table>
    <thead>
        <tr class="active">
            <th>Наименование</th>
            <th>Параметры</th>
            <th>Кол-во, шт.</th>
            <th>Цена, [[+currency]]</th>
        </tr>
    </thead>
    <tbody>
        [[+purchases]]
    </tbody>
    <tfoot>
        <tr class="cart-order">
            <td colspan="3" style="text-align: right;">
                [[+delivery]]
            </td>
            <td>
                <b>[[+delivery_price:num_format]]</b>
            </td>
        </tr>
        <tr class="cart-order">
            <td colspan="3" style="text-align: right;">
                <b>Итого:</b>
            </td>
            <td>
                <b>[[+price:num_format]]</b>
            </td>
        </tr>
    </tfoot>
</table>

<p><b>Контактные данные</b></p>

<table>
    <colgroup>
        <col width="50%" span="2">
    </colgroup>
    <tbody>
        [[+contacts]]
    </tbody>
</table>',
    ),
  ),
  '5a59e1d6aee26c20976196c6ea31309d' => 
  array (
    'criteria' => 
    array (
      'name' => 'orderDataRow',
    ),
    'object' => 
    array (
      'id' => 10,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'orderDataRow',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '<tr class="cart-order">
    <td>
        <b>[[+name]]</b>
    </td>
    <td>
        [[+addit_data:default=`&mdash;`]]
    </td>
    <td>
        [[+count]] шт.
    </td>
    <td>
        [[+price]] [[+currency]]
    </td>
</tr>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '<tr class="cart-order">
    <td>
        <b>[[+name]]</b>
    </td>
    <td>
        [[+addit_data:default=`&mdash;`]]
    </td>
    <td>
        [[+count]] шт.
    </td>
    <td>
        [[+price]] [[+currency]]
    </td>
</tr>',
    ),
  ),
  'e574ef7e50ec6c41546c314f7079d295' => 
  array (
    'criteria' => 
    array (
      'name' => 'mailContactsRow',
    ),
    'object' => 
    array (
      'id' => 11,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'mailContactsRow',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '<tr>
    <td>[[+label]]:</td>
    <td>[[+value]]</td>
</tr>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '<tr>
    <td>[[+label]]:</td>
    <td>[[+value]]</td>
</tr>',
    ),
  ),
  'a2db0a8e7263354fe242e6a7e93509b7' => 
  array (
    'criteria' => 
    array (
      'name' => 'select_option',
    ),
    'object' => 
    array (
      'id' => 12,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'select_option',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '<option value="[[+value]]" [[+selected]]>[[+label]]</option>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '<option value="[[+value]]" [[+selected]]>[[+label]]</option>',
    ),
  ),
  '21f6aa807b91dd23b53ac27ed63cd9d0' => 
  array (
    'criteria' => 
    array (
      'name' => 'userMail',
    ),
    'object' => 
    array (
      'id' => 13,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'userMail',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '<!DOCTYPE html>
<html>

<head>
<style type="text/css">
body{background-color:#fff;}
table {width:650px; margin:10px 0; border:1px solid #BCBCBC; border-collapse:collapse;}
table td {padding:5px; border:1px solid #BCBCBC;}
</style>
</head>

<body>

<p><b>[[++site_name]]</b></p>

<p>Изменен статус заказа.</p>

<div style="padding:15px 0; margin:15px 0; border-top:3px solid #BCBCBC; border-bottom:3px solid #BCBCBC;">

    <p>Номер заказа: [[+orderID]]</p>
    
    <p>Дата: [[+orderDate]].</p>
    
    <p>Ваш заказ переведен в статус: <b>[[+statusName]]</b>.</p>
    
    [[+orderOutputData]]

</div>

<a href="[[++site_url]]" target="_blank">[[++site_url]]</a>

<br /><br />

</body>
</html>',
      'locked' => 0,
      'properties' => NULL,
      'static' => 0,
      'static_file' => '',
      'content' => '<!DOCTYPE html>
<html>

<head>
<style type="text/css">
body{background-color:#fff;}
table {width:650px; margin:10px 0; border:1px solid #BCBCBC; border-collapse:collapse;}
table td {padding:5px; border:1px solid #BCBCBC;}
</style>
</head>

<body>

<p><b>[[++site_name]]</b></p>

<p>Изменен статус заказа.</p>

<div style="padding:15px 0; margin:15px 0; border-top:3px solid #BCBCBC; border-bottom:3px solid #BCBCBC;">

    <p>Номер заказа: [[+orderID]]</p>
    
    <p>Дата: [[+orderDate]].</p>
    
    <p>Ваш заказ переведен в статус: <b>[[+statusName]]</b>.</p>
    
    [[+orderOutputData]]

</div>

<a href="[[++site_url]]" target="_blank">[[++site_url]]</a>

<br /><br />

</body>
</html>',
    ),
  ),
  '7ef8168e04ed1c58b32398dc4d589d94' => 
  array (
    'criteria' => 
    array (
      'name' => 'Shopkeeper3',
    ),
    'object' => 
    array (
      'id' => 21,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'Shopkeeper3',
      'description' => 'Shopping cart',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '/**
 * Shopkeeper
 * 
 * Shopping cart for MODx Revolution
 *
 * @package shopkeeper3
 * @category 	   snippet
 * @version 	   3.x
 * @license 	   http://www.gnu.org/copyleft/gpl.html GNU Public License (GPL)
 * @internal	   @properties
 * @internal	   @modx_category Shop
 */

if(isset($hideOn) && preg_match(\'/(^|\\s|,)\'.$modx->resource->get(\'id\').\'(,|$)/\',$hideOn)) return \'\';

$modx->placeholders[\'SHK_callCount\'] = isset($modx->placeholders[\'SHK_callCount\']) ? $modx->placeholders[\'SHK_callCount\']+1 : 1;
$SHK_callCount = $modx->placeholders[\'SHK_callCount\'];
if( !defined( \'SHOPKEEPER_URL\' ) ) define( \'SHOPKEEPER_URL\', $modx->getOption(\'assets_url\') . "components/shopkeeper3/" );

$output = \'\';

require_once $modx->getOption(\'core_path\') . "components/shopkeeper3/model/shopkeeper.class.php";

$shopCart = new Shopkeeper($modx, $scriptProperties, true);
$noJavaScript = $modx->getOption( \'noJavaScript\', $scriptProperties, false );
$optStyles = $modx->getOption(\'style\', $scriptProperties, 1);
$optJsScripts = $modx->getOption(\'jsScript\', $scriptProperties, 1);

if( $SHK_callCount === 1 ){
    
    if( $optStyles ){
        $modx->regClientCSS( SHOPKEEPER_URL . "web/css/".$modx->getOption( \'style\', $scriptProperties, \'default\' ) . "/style.css" );
    }

    if( !$modx->getOption(\'noJQuery\', $scriptProperties, false) ){
        $modx->regClientScript(SHOPKEEPER_URL . "web/js/jquery-3.1.1.min.js");
    }

    if( $optJsScripts ) {

        if( $optJsScripts != 2 ) {

            $modx->regClientScript(SHOPKEEPER_URL . "web/js/lang/" . $modx->getOption(\'lang\', $scriptProperties, \'ru\') . ".js?v=" . $shopCart->getVersion());
            $modx->regClientScript(SHOPKEEPER_URL . "web/js/shopkeeper.js?v=" . $shopCart->getVersion());

        }

        $shk_opts = array(
            \'prodCont\' => $modx->getOption(\'prodCont\', $scriptProperties, \'div.shk-item\'),
            \'site_base_url\' => $modx->config[\'base_url\'],
            \'counterField\' => $modx->getOption(\'counterField\', $scriptProperties, false),
            \'counterFieldCart\' => $modx->getOption(\'counterFieldCart\', $scriptProperties, true),
            \'changePrice\' => $modx->getOption(\'changePrice\', $scriptProperties, true),
            \'flyToCart\' => $modx->getOption(\'flyToCart\', $scriptProperties, \'helper\'),
            \'noLoader\' => $modx->getOption(\'noLoader\', $scriptProperties, false),
            \'allowFloatCount\' => $modx->getOption(\'allowFloatCount\', $scriptProperties, false),
            \'animCart\' => $modx->getOption(\'animCart\', $scriptProperties, true),
            \'goToOrderFormPage\' => $modx->getOption(\'goToOrderFormPage\', $scriptProperties, false),
            //\'orderFormPage\' => $modx->getOption(\'orderFormPage\',$scriptProperties,0),
            \'orderFormPageUrl\' => $modx->makeUrl($modx->getOption(\'orderFormPageId\', $scriptProperties, 1), \'\', \'\', \'abs\'),
            \'debug\' => $modx->getOption(\'debug\', $scriptProperties, false)
        );

        $delivery_price = !empty($shopCart->delivery[\'price\']) ? number_format($shopCart->delivery[\'price\'], 2, \'.\', \'\') : 0;
        $delivery_name = !empty($shopCart->delivery[\'label\']) ? $shopCart->delivery[\'label\'] : \'\';

        $shk_data = array(
            \'price_total\' => number_format(Shopkeeper::$price_total, 2, \'.\', \'\'),
            \'items_total\' => Shopkeeper::$items_total,
            \'items_unique_total\' => Shopkeeper::$items_unique_total,
            \'delivery_price\' => $delivery_price,
            \'delivery_name\' => $delivery_name,
            \'ids\' => $shopCart->getProdIds()
        );

        $shk_data_str = json_encode($shk_data);
        $options_obj_str = json_encode($shk_opts);

        //create script
        $headHtml = "\\t<script type=\\"text/javascript\\">";
        $headHtml .= "
        SHK.data = " . $shk_data_str . ";
        jQuery(document).ready(function(){
            SHK.init( " . $options_obj_str . " );
        });" . PHP_EOL;

        $headHtml .= "\\t</script>" . PHP_EOL;

        $modx->regClientScript($headHtml);

    }
    
}

//вывод корзины
$output .= $shopCart->getCartContent();

return $output;',
      'locked' => 0,
      'properties' => 'a:35:{s:4:"lang";a:7:{s:4:"name";s:4:"lang";s:4:"desc";s:13:"prop_shk.lang";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:2:"ru";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:8:"prodCont";a:7:{s:4:"name";s:8:"prodCont";s:4:"desc";s:17:"prop_shk.prodcont";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:12:"div.shk-item";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:7:"tplPath";a:7:{s:4:"name";s:7:"tplPath";s:4:"desc";s:16:"prop_shk.tplpath";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:47:"core/components/shopkeeper3/elements/chunks/ru/";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:7:"cartTpl";a:7:{s:4:"name";s:7:"cartTpl";s:4:"desc";s:16:"prop_shk.carttpl";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:18:"@FILE shopCart.tpl";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:10:"cartRowTpl";a:7:{s:4:"name";s:10:"cartRowTpl";s:4:"desc";s:19:"prop_shk.cartrowtpl";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:21:"@FILE shopCartRow.tpl";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:12:"orderDataTpl";a:7:{s:4:"name";s:12:"orderDataTpl";s:4:"desc";s:21:"prop_shk.orderdatatpl";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:19:"@FILE orderData.tpl";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:9:"flyToCart";a:7:{s:4:"name";s:9:"flyToCart";s:4:"desc";s:18:"prop_shk.flytocart";s:4:"type";s:4:"list";s:7:"options";a:4:{i:0;a:2:{s:4:"text";s:6:"helper";s:5:"value";s:6:"helper";}i:1;a:2:{s:4:"text";s:5:"image";s:5:"value";s:5:"image";}i:2;a:2:{s:4:"text";s:11:"scrollimage";s:5:"value";s:11:"scrollimage";}i:3;a:2:{s:4:"text";s:5:"nofly";s:5:"value";s:5:"nofly";}}s:5:"value";s:6:"helper";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:10:"fieldPrice";a:7:{s:4:"name";s:10:"fieldPrice";s:4:"desc";s:16:"prop_shk.pricetv";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:5:"price";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:5:"style";a:7:{s:4:"name";s:5:"style";s:4:"desc";s:14:"prop_shk.style";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:7:"default";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:8:"currency";a:7:{s:4:"name";s:8:"currency";s:4:"desc";s:17:"prop_shk.currency";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:7:"руб.";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:9:"noCounter";a:7:{s:4:"name";s:9:"noCounter";s:4:"desc";s:18:"prop_shk.nocounter";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:8:"noLoader";a:7:{s:4:"name";s:8:"noLoader";s:4:"desc";s:17:"prop_shk.noloader";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:15:"orderFormPageId";a:7:{s:4:"name";s:15:"orderFormPageId";s:4:"desc";s:22:"prop_shk.orderformpage";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"1";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:17:"goToOrderFormPage";a:7:{s:4:"name";s:17:"goToOrderFormPage";s:4:"desc";s:26:"prop_shk.gotoorderformpage";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:12:"counterField";a:7:{s:4:"name";s:12:"counterField";s:4:"desc";s:21:"prop_shk.counterfield";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:16:"counterFieldCart";a:7:{s:4:"name";s:16:"counterFieldCart";s:4:"desc";s:25:"prop_shk.counterFieldCart";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:1;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:15:"excepDigitGroup";a:7:{s:4:"name";s:15:"excepDigitGroup";s:4:"desc";s:24:"prop_shk.excepdigitgroup";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:1;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:11:"changePrice";a:7:{s:4:"name";s:11:"changePrice";s:4:"desc";s:20:"prop_shk.changeprice";s:4:"type";s:4:"list";s:7:"options";a:3:{i:0;a:2:{s:4:"text";s:3:"yes";s:5:"value";s:1:"1";}i:1;a:2:{s:4:"text";s:2:"no";s:5:"value";s:1:"0";}i:2;a:2:{s:4:"text";s:7:"replace";s:5:"value";s:7:"replace";}}s:5:"value";s:1:"1";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:8:"animCart";a:7:{s:4:"name";s:8:"animCart";s:4:"desc";s:17:"prop_shk.animcart";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:1;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:15:"allowFloatCount";a:7:{s:4:"name";s:15:"allowFloatCount";s:4:"desc";s:24:"prop_shk.allowfloatcount";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:8:"jsScript";a:7:{s:4:"name";s:8:"jsScript";s:4:"desc";s:21:"prop_shk.nojavascript";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"1";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:8:"noJQuery";a:7:{s:4:"name";s:8:"noJQuery";s:4:"desc";s:17:"prop_shk.nojquery";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:10:"noConflict";a:7:{s:4:"name";s:10:"noConflict";s:4:"desc";s:19:"prop_shk.noconflict";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:6:"hideOn";a:7:{s:4:"name";s:6:"hideOn";s:4:"desc";s:15:"prop_shk.hideon";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:10:"TVsaveList";a:7:{s:4:"name";s:10:"TVsaveList";s:4:"desc";s:19:"prop_shk.TVsaveList";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:14:"fromParentList";a:7:{s:4:"name";s:14:"fromParentList";s:4:"desc";s:23:"prop_shk.fromParentList";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:16:"fromParentHeight";a:7:{s:4:"name";s:16:"fromParentHeight";s:4:"desc";s:25:"prop_shk.fromParentHeight";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"1";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:16:"additParamSource";a:7:{s:4:"name";s:16:"additParamSource";s:4:"desc";s:25:"prop_shk.additParamSource";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:9:"className";a:7:{s:4:"name";s:9:"className";s:4:"desc";s:18:"prop_shk.className";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:11:"modResource";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:11:"packageName";a:7:{s:4:"name";s:11:"packageName";s:4:"desc";s:20:"prop_shk.packageName";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:19:"savePurchasesFields";a:7:{s:4:"name";s:19:"savePurchasesFields";s:4:"desc";s:28:"prop_shk.savePurchasesFields";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:5:"debug";a:7:{s:4:"name";s:5:"debug";s:4:"desc";s:14:"prop_shk.debug";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:13:"processParams";a:7:{s:4:"name";s:13:"processParams";s:4:"desc";s:22:"prop_shk.processParams";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"0";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:11:"pluralWords";a:7:{s:4:"name";s:11:"pluralWords";s:4:"desc";s:20:"prop_shk.pluralWords";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}s:7:"groupBy";a:7:{s:4:"name";s:7:"groupBy";s:4:"desc";s:16:"prop_shk.groupBy";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:22:"shopkeeper3:properties";s:4:"area";s:0:"";}}',
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/**
 * Shopkeeper
 * 
 * Shopping cart for MODx Revolution
 *
 * @package shopkeeper3
 * @category 	   snippet
 * @version 	   3.x
 * @license 	   http://www.gnu.org/copyleft/gpl.html GNU Public License (GPL)
 * @internal	   @properties
 * @internal	   @modx_category Shop
 */

if(isset($hideOn) && preg_match(\'/(^|\\s|,)\'.$modx->resource->get(\'id\').\'(,|$)/\',$hideOn)) return \'\';

$modx->placeholders[\'SHK_callCount\'] = isset($modx->placeholders[\'SHK_callCount\']) ? $modx->placeholders[\'SHK_callCount\']+1 : 1;
$SHK_callCount = $modx->placeholders[\'SHK_callCount\'];
if( !defined( \'SHOPKEEPER_URL\' ) ) define( \'SHOPKEEPER_URL\', $modx->getOption(\'assets_url\') . "components/shopkeeper3/" );

$output = \'\';

require_once $modx->getOption(\'core_path\') . "components/shopkeeper3/model/shopkeeper.class.php";

$shopCart = new Shopkeeper($modx, $scriptProperties, true);
$noJavaScript = $modx->getOption( \'noJavaScript\', $scriptProperties, false );
$optStyles = $modx->getOption(\'style\', $scriptProperties, 1);
$optJsScripts = $modx->getOption(\'jsScript\', $scriptProperties, 1);

if( $SHK_callCount === 1 ){
    
    if( $optStyles ){
        $modx->regClientCSS( SHOPKEEPER_URL . "web/css/".$modx->getOption( \'style\', $scriptProperties, \'default\' ) . "/style.css" );
    }

    if( !$modx->getOption(\'noJQuery\', $scriptProperties, false) ){
        $modx->regClientScript(SHOPKEEPER_URL . "web/js/jquery-3.1.1.min.js");
    }

    if( $optJsScripts ) {

        if( $optJsScripts != 2 ) {

            $modx->regClientScript(SHOPKEEPER_URL . "web/js/lang/" . $modx->getOption(\'lang\', $scriptProperties, \'ru\') . ".js?v=" . $shopCart->getVersion());
            $modx->regClientScript(SHOPKEEPER_URL . "web/js/shopkeeper.js?v=" . $shopCart->getVersion());

        }

        $shk_opts = array(
            \'prodCont\' => $modx->getOption(\'prodCont\', $scriptProperties, \'div.shk-item\'),
            \'site_base_url\' => $modx->config[\'base_url\'],
            \'counterField\' => $modx->getOption(\'counterField\', $scriptProperties, false),
            \'counterFieldCart\' => $modx->getOption(\'counterFieldCart\', $scriptProperties, true),
            \'changePrice\' => $modx->getOption(\'changePrice\', $scriptProperties, true),
            \'flyToCart\' => $modx->getOption(\'flyToCart\', $scriptProperties, \'helper\'),
            \'noLoader\' => $modx->getOption(\'noLoader\', $scriptProperties, false),
            \'allowFloatCount\' => $modx->getOption(\'allowFloatCount\', $scriptProperties, false),
            \'animCart\' => $modx->getOption(\'animCart\', $scriptProperties, true),
            \'goToOrderFormPage\' => $modx->getOption(\'goToOrderFormPage\', $scriptProperties, false),
            //\'orderFormPage\' => $modx->getOption(\'orderFormPage\',$scriptProperties,0),
            \'orderFormPageUrl\' => $modx->makeUrl($modx->getOption(\'orderFormPageId\', $scriptProperties, 1), \'\', \'\', \'abs\'),
            \'debug\' => $modx->getOption(\'debug\', $scriptProperties, false)
        );

        $delivery_price = !empty($shopCart->delivery[\'price\']) ? number_format($shopCart->delivery[\'price\'], 2, \'.\', \'\') : 0;
        $delivery_name = !empty($shopCart->delivery[\'label\']) ? $shopCart->delivery[\'label\'] : \'\';

        $shk_data = array(
            \'price_total\' => number_format(Shopkeeper::$price_total, 2, \'.\', \'\'),
            \'items_total\' => Shopkeeper::$items_total,
            \'items_unique_total\' => Shopkeeper::$items_unique_total,
            \'delivery_price\' => $delivery_price,
            \'delivery_name\' => $delivery_name,
            \'ids\' => $shopCart->getProdIds()
        );

        $shk_data_str = json_encode($shk_data);
        $options_obj_str = json_encode($shk_opts);

        //create script
        $headHtml = "\\t<script type=\\"text/javascript\\">";
        $headHtml .= "
        SHK.data = " . $shk_data_str . ";
        jQuery(document).ready(function(){
            SHK.init( " . $options_obj_str . " );
        });" . PHP_EOL;

        $headHtml .= "\\t</script>" . PHP_EOL;

        $modx->regClientScript($headHtml);

    }
    
}

//вывод корзины
$output .= $shopCart->getCartContent();

return $output;',
    ),
  ),
  '12627cc0903adf2b967bde5973f84a1e' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk_fihook',
    ),
    'object' => 
    array (
      'id' => 22,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shk_fihook',
      'description' => 'FormIt hook for Shopkeeper',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '/**
 * FormIt hook for Shopkeeper 3.x
 */

//ini_set(\'display_errors\',1);
//error_reporting(E_ALL);

$output = false;

if(!defined(\'SHOPKEEPER_PATH\')){
    define(\'SHOPKEEPER_PATH\', MODX_CORE_PATH."components/shopkeeper3/");
}

//Определяем параметры сниппета Shopkeeper
$sys_property_sets = $modx->getOption( \'shk3.property_sets\', $modx->config, \'default\' );
$sys_property_sets = explode( \',\', $sys_property_sets );
$propertySetName = trim( current( $sys_property_sets ) );

$snippet = $modx->getObject(\'modSnippet\',array(\'name\'=>\'Shopkeeper3\'));
$properties = $snippet->getProperties();
if( $propertySetName != \'default\' && $modx->getCount( \'modPropertySet\', array( \'name\' => $propertySetName ) ) > 0 ){
    $propSet = $modx->getObject( \'modPropertySet\', array( \'name\' => $propertySetName ) );
    $propSetProperties = $propSet->getProperties();
    if(is_array($propSetProperties)) $properties = array_merge($properties,$propSetProperties);
}

$lang = $modx->getOption( \'lang\', $properties, \'ru\' );
$modx->getService( \'lexicon\', \'modLexicon\' );
$modx->lexicon->load( $lang . \':shopkeeper3:default\' );

if( !empty( $_SESSION[\'shk_order\'] ) ){
    
    require_once SHOPKEEPER_PATH . "model/shopkeeper.class.php";
    $shopCart = new Shopkeeper( $modx, $properties );
    
    $modx->addPackage( \'shopkeeper3\', SHOPKEEPER_PATH . \'model/\' );
    
    //shopkeeper settings
    $contacts_fields = array();
    $response = $modx->runProcessor(\'getsettings\',
        array( \'settings\' => array(\'contacts_fields\') ),
        array( \'processors_path\' => $modx->getOption( \'core_path\' ) . \'components/shopkeeper3/processors/mgr/\' )
    );
    if ($response->isError()) {
        echo $response->getMessage();
    }
    if($result = $response->getResponse()){
        
        $temp_arr = !empty( $result[\'object\'][\'contacts_fields\'] ) ? $result[\'object\'][\'contacts_fields\'] : array();
        if( !empty( $temp_arr ) ){
            
            foreach( $temp_arr as $opt ){
                
                $contacts_fields[$opt[\'name\']] = $opt;
                
            }
            
        }
        
    }
    
    $userId = $modx->getLoginUserID( $modx->context->key );
    if( !$userId ) $userId = 0;
    
    //Контактные данные
    $contacts = array();
    $allFormFields = $hook->getValues();
    foreach( $allFormFields as $key => $val ){
        
        if( in_array( $key, array_keys( $contacts_fields ) ) ){
            
            $temp_arr = array(
                \'name\' => $contacts_fields[$key][\'name\'],
                \'value\' => $val,
                \'label\' => $contacts_fields[$key][\'label\']
            );
            
            array_push( $contacts, $temp_arr );
            
        }
        
    }
    
    $contacts = json_encode( $contacts );
    
    $emailField = $modx->getOption( \'fiarToField\', $hook->config, \'email\' );
    $phoneField = $modx->getOption( \'phoneField\', $hook->config, \'phone\' );
    $deliveryField = $modx->getOption( \'deliveryField\', $hook->config, \'shk_delivery\' );
    $paymentField = $modx->getOption( \'paymentField\', $hook->config, \'payment\' );
    
    //Доставка
    $delivery_price = !empty( $shopCart->delivery[\'price\'] ) ? $shopCart->delivery[\'price\'] : 0;
    $delivery_name = !empty( $shopCart->delivery[\'label\'] ) ? $shopCart->delivery[\'label\'] : \'\';
    if( !$delivery_name ){
	$delivery_name = !empty( $allFormFields[$deliveryField] ) ? $allFormFields[$deliveryField] : \'\';
    }
    
    //Сохраняем данные заказа
    $order = $modx->newObject(\'shk_order\');
    $insert_data = array(
        \'contacts\' => $contacts,
        \'options\' => \'\',
        \'price\' => Shopkeeper::$price_total,
        \'currency\' => $shopCart->config[\'currency\'],
        \'date\' => strftime(\'%Y-%m-%d %H:%M:%S\'),
        \'sentdate\' => strftime(\'%Y-%m-%d %H:%M:%S\'),
        \'note\' => \'\',
        \'email\' => isset( $allFormFields[$emailField] ) ? $allFormFields[$emailField] : \'\',
        \'delivery\' => $delivery_name,
        \'delivery_price\' => $delivery_price,
        \'payment\' => isset( $allFormFields[$paymentField] ) ? $allFormFields[$paymentField] : \'\',
        \'tracking_num\' => \'\',
        \'phone\' => isset( $allFormFields[$phoneField] ) ? $allFormFields[$phoneField] : \'\',
        \'status\' => $modx->getOption( \'shk3.first_status\', null, \'1\' )
    );
    if( $userId ){
        $insert_data[\'userid\'] = $userId;
    }
    $order->fromArray($insert_data);
    $saved = $order->save();
    
    //Сохраняем товары заказа
    if( $saved ){

        $purchasesData = $shopCart->getProductsData( true );

        foreach( $shopCart->data as $key => $p_data ){

            $options = !empty( $p_data[\'options\'] ) ? json_encode( $p_data[\'options\'] ) : \'\';
            $fields_data = !empty( $purchasesData[ $key ] ) ? $purchasesData[ $key ] : array();
            $fields_data[\'url\'] = !empty( $p_data[\'url\'] ) ? $p_data[\'url\'] : \'\';
            unset( $fields_data[\'id\'] );
            $fields_data_str = json_encode( $fields_data );

            $insert_data = array(
                \'p_id\' => $p_data[\'id\'],
                \'order_id\' => $order->id,
                \'name\' => $p_data[\'name\'],
                \'price\' => $p_data[\'price\'],
                \'count\' => $p_data[\'count\'],
                \'class_name\' => $p_data[\'className\'],
                \'package_name\' => $p_data[\'packageName\'],
                \'data\' => $fields_data_str,
                \'options\' => $options
            );

            $purchase = $modx->newObject(\'shk_purchases\');
            $purchase->fromArray( $insert_data );
            $purchase->save();

        }

        $shopCart->setOrderDataSession( $order->toArray() );

    }
    
    $modx->invokeEvent( \'OnSHKChangeStatus\', array( \'order_ids\' => array( $order->id ), \'status\' => $order->status ) );
    
    $orderOutputData = $shopCart->getOrderData( $order->id );
    
    //OnSHKsaveOrder
    $evtOut = $modx->invokeEvent(\'OnSHKsaveOrder\',array(\'order_id\' => $order->get(\'id\')));
    if(is_array($evtOut)) $orderOutputData .= implode(\'\',$evtOut);
    
    $hook->setValues(array(
        \'orderID\' => $order->get(\'id\'),
        \'orderDate\' => $order->get(\'date\'),
        \'orderPrice\' => $order->get(\'price\'),
        \'orderCurrency\' => $shopCart->config[\'currency\'],
        \'orderOutputData\' => $orderOutputData
    ));
    
    $shopCart->request_empty( false );
    
    $output = true;
    
}else{
    
    $hook->addError( \'error_message\', $modx->lexicon(\'shk.order_empty\') );
    $output = false;
    
}

return $output;',
      'locked' => 0,
      'properties' => NULL,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/**
 * FormIt hook for Shopkeeper 3.x
 */

//ini_set(\'display_errors\',1);
//error_reporting(E_ALL);

$output = false;

if(!defined(\'SHOPKEEPER_PATH\')){
    define(\'SHOPKEEPER_PATH\', MODX_CORE_PATH."components/shopkeeper3/");
}

//Определяем параметры сниппета Shopkeeper
$sys_property_sets = $modx->getOption( \'shk3.property_sets\', $modx->config, \'default\' );
$sys_property_sets = explode( \',\', $sys_property_sets );
$propertySetName = trim( current( $sys_property_sets ) );

$snippet = $modx->getObject(\'modSnippet\',array(\'name\'=>\'Shopkeeper3\'));
$properties = $snippet->getProperties();
if( $propertySetName != \'default\' && $modx->getCount( \'modPropertySet\', array( \'name\' => $propertySetName ) ) > 0 ){
    $propSet = $modx->getObject( \'modPropertySet\', array( \'name\' => $propertySetName ) );
    $propSetProperties = $propSet->getProperties();
    if(is_array($propSetProperties)) $properties = array_merge($properties,$propSetProperties);
}

$lang = $modx->getOption( \'lang\', $properties, \'ru\' );
$modx->getService( \'lexicon\', \'modLexicon\' );
$modx->lexicon->load( $lang . \':shopkeeper3:default\' );

if( !empty( $_SESSION[\'shk_order\'] ) ){
    
    require_once SHOPKEEPER_PATH . "model/shopkeeper.class.php";
    $shopCart = new Shopkeeper( $modx, $properties );
    
    $modx->addPackage( \'shopkeeper3\', SHOPKEEPER_PATH . \'model/\' );
    
    //shopkeeper settings
    $contacts_fields = array();
    $response = $modx->runProcessor(\'getsettings\',
        array( \'settings\' => array(\'contacts_fields\') ),
        array( \'processors_path\' => $modx->getOption( \'core_path\' ) . \'components/shopkeeper3/processors/mgr/\' )
    );
    if ($response->isError()) {
        echo $response->getMessage();
    }
    if($result = $response->getResponse()){
        
        $temp_arr = !empty( $result[\'object\'][\'contacts_fields\'] ) ? $result[\'object\'][\'contacts_fields\'] : array();
        if( !empty( $temp_arr ) ){
            
            foreach( $temp_arr as $opt ){
                
                $contacts_fields[$opt[\'name\']] = $opt;
                
            }
            
        }
        
    }
    
    $userId = $modx->getLoginUserID( $modx->context->key );
    if( !$userId ) $userId = 0;
    
    //Контактные данные
    $contacts = array();
    $allFormFields = $hook->getValues();
    foreach( $allFormFields as $key => $val ){
        
        if( in_array( $key, array_keys( $contacts_fields ) ) ){
            
            $temp_arr = array(
                \'name\' => $contacts_fields[$key][\'name\'],
                \'value\' => $val,
                \'label\' => $contacts_fields[$key][\'label\']
            );
            
            array_push( $contacts, $temp_arr );
            
        }
        
    }
    
    $contacts = json_encode( $contacts );
    
    $emailField = $modx->getOption( \'fiarToField\', $hook->config, \'email\' );
    $phoneField = $modx->getOption( \'phoneField\', $hook->config, \'phone\' );
    $deliveryField = $modx->getOption( \'deliveryField\', $hook->config, \'shk_delivery\' );
    $paymentField = $modx->getOption( \'paymentField\', $hook->config, \'payment\' );
    
    //Доставка
    $delivery_price = !empty( $shopCart->delivery[\'price\'] ) ? $shopCart->delivery[\'price\'] : 0;
    $delivery_name = !empty( $shopCart->delivery[\'label\'] ) ? $shopCart->delivery[\'label\'] : \'\';
    if( !$delivery_name ){
	$delivery_name = !empty( $allFormFields[$deliveryField] ) ? $allFormFields[$deliveryField] : \'\';
    }
    
    //Сохраняем данные заказа
    $order = $modx->newObject(\'shk_order\');
    $insert_data = array(
        \'contacts\' => $contacts,
        \'options\' => \'\',
        \'price\' => Shopkeeper::$price_total,
        \'currency\' => $shopCart->config[\'currency\'],
        \'date\' => strftime(\'%Y-%m-%d %H:%M:%S\'),
        \'sentdate\' => strftime(\'%Y-%m-%d %H:%M:%S\'),
        \'note\' => \'\',
        \'email\' => isset( $allFormFields[$emailField] ) ? $allFormFields[$emailField] : \'\',
        \'delivery\' => $delivery_name,
        \'delivery_price\' => $delivery_price,
        \'payment\' => isset( $allFormFields[$paymentField] ) ? $allFormFields[$paymentField] : \'\',
        \'tracking_num\' => \'\',
        \'phone\' => isset( $allFormFields[$phoneField] ) ? $allFormFields[$phoneField] : \'\',
        \'status\' => $modx->getOption( \'shk3.first_status\', null, \'1\' )
    );
    if( $userId ){
        $insert_data[\'userid\'] = $userId;
    }
    $order->fromArray($insert_data);
    $saved = $order->save();
    
    //Сохраняем товары заказа
    if( $saved ){

        $purchasesData = $shopCart->getProductsData( true );

        foreach( $shopCart->data as $key => $p_data ){

            $options = !empty( $p_data[\'options\'] ) ? json_encode( $p_data[\'options\'] ) : \'\';
            $fields_data = !empty( $purchasesData[ $key ] ) ? $purchasesData[ $key ] : array();
            $fields_data[\'url\'] = !empty( $p_data[\'url\'] ) ? $p_data[\'url\'] : \'\';
            unset( $fields_data[\'id\'] );
            $fields_data_str = json_encode( $fields_data );

            $insert_data = array(
                \'p_id\' => $p_data[\'id\'],
                \'order_id\' => $order->id,
                \'name\' => $p_data[\'name\'],
                \'price\' => $p_data[\'price\'],
                \'count\' => $p_data[\'count\'],
                \'class_name\' => $p_data[\'className\'],
                \'package_name\' => $p_data[\'packageName\'],
                \'data\' => $fields_data_str,
                \'options\' => $options
            );

            $purchase = $modx->newObject(\'shk_purchases\');
            $purchase->fromArray( $insert_data );
            $purchase->save();

        }

        $shopCart->setOrderDataSession( $order->toArray() );

    }
    
    $modx->invokeEvent( \'OnSHKChangeStatus\', array( \'order_ids\' => array( $order->id ), \'status\' => $order->status ) );
    
    $orderOutputData = $shopCart->getOrderData( $order->id );
    
    //OnSHKsaveOrder
    $evtOut = $modx->invokeEvent(\'OnSHKsaveOrder\',array(\'order_id\' => $order->get(\'id\')));
    if(is_array($evtOut)) $orderOutputData .= implode(\'\',$evtOut);
    
    $hook->setValues(array(
        \'orderID\' => $order->get(\'id\'),
        \'orderDate\' => $order->get(\'date\'),
        \'orderPrice\' => $order->get(\'price\'),
        \'orderCurrency\' => $shopCart->config[\'currency\'],
        \'orderOutputData\' => $orderOutputData
    ));
    
    $shopCart->request_empty( false );
    
    $output = true;
    
}else{
    
    $hook->addError( \'error_message\', $modx->lexicon(\'shk.order_empty\') );
    $output = false;
    
}

return $output;',
    ),
  ),
  '288d997a0d004cbb8dde08cbf89d91b7' => 
  array (
    'criteria' => 
    array (
      'name' => 'shkOptions',
    ),
    'object' => 
    array (
      'id' => 23,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shkOptions',
      'description' => 'Print configuration of Shopkeeper',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '/**
 * shkOptions
 * Сниппет выводит данные из конфигурации Shopkeeper
 *
 */

$output = array();

$get = $modx->getOption( \'get\', $scriptProperties, \'\' );
$post_name = explode( \',\', $modx->getOption( \'post_name\', $scriptProperties, $get ) );
$get = explode( \',\', $get );
$get = array_map( \'trim\', $get );
$post_name = array_map( \'trim\', $post_name );
$tpl = $modx->getOption( \'tpl\', $scriptProperties, \'\' );
$toPlaceholders = $modx->getOption( \'toPlaceholders\', $scriptProperties, false );
$pl_prefix = $modx->getOption( \'pl_prefix\', $scriptProperties, \'shkopt_\' );

if( empty( $get ) ) return \'\';

if( class_exists(\'Shopkeeper\') ){
    
    $config = Shopkeeper::getConfig( $get );
    
    //echo \'<pre>\' . print_r( $config, true ) . \'</pre>\';
    
    if( !empty( $config ) ){
        
        foreach( $get as $index => $opt_name ){
            
            if( !empty( $config[ $opt_name ] ) ){
                
                $output[ $opt_name ] = \'\';
                
                foreach( $config[ $opt_name ] as $key => $conf ){
                    
                    if( empty( $conf[\'value\'] ) ){
                        $conf[\'value\'] = $conf[\'label\'];
                    }
                    
                    $conf[\'selected\'] = ( isset( $post_name[$index] ) && isset( $_POST[ $post_name[$index] ] ) && $_POST[ $post_name[$index] ] == $conf[\'value\'] ? \'selected="selected"\' : \'\' );
                    
                    $output[ $opt_name ] .= $modx->getChunk( $tpl, $conf ) . PHP_EOL . "\\t";
                    
                }
                
            }
            
        }
        
    }
    
}

if( $toPlaceholders ){
    
    foreach( $output as $pl_name => $out ){
        $modx->setPlaceholder( $pl_prefix . $pl_name, $out );
    }
    
    $output = array();
    
}

return implode( \'\', $output );',
      'locked' => 0,
      'properties' => NULL,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/**
 * shkOptions
 * Сниппет выводит данные из конфигурации Shopkeeper
 *
 */

$output = array();

$get = $modx->getOption( \'get\', $scriptProperties, \'\' );
$post_name = explode( \',\', $modx->getOption( \'post_name\', $scriptProperties, $get ) );
$get = explode( \',\', $get );
$get = array_map( \'trim\', $get );
$post_name = array_map( \'trim\', $post_name );
$tpl = $modx->getOption( \'tpl\', $scriptProperties, \'\' );
$toPlaceholders = $modx->getOption( \'toPlaceholders\', $scriptProperties, false );
$pl_prefix = $modx->getOption( \'pl_prefix\', $scriptProperties, \'shkopt_\' );

if( empty( $get ) ) return \'\';

if( class_exists(\'Shopkeeper\') ){
    
    $config = Shopkeeper::getConfig( $get );
    
    //echo \'<pre>\' . print_r( $config, true ) . \'</pre>\';
    
    if( !empty( $config ) ){
        
        foreach( $get as $index => $opt_name ){
            
            if( !empty( $config[ $opt_name ] ) ){
                
                $output[ $opt_name ] = \'\';
                
                foreach( $config[ $opt_name ] as $key => $conf ){
                    
                    if( empty( $conf[\'value\'] ) ){
                        $conf[\'value\'] = $conf[\'label\'];
                    }
                    
                    $conf[\'selected\'] = ( isset( $post_name[$index] ) && isset( $_POST[ $post_name[$index] ] ) && $_POST[ $post_name[$index] ] == $conf[\'value\'] ? \'selected="selected"\' : \'\' );
                    
                    $output[ $opt_name ] .= $modx->getChunk( $tpl, $conf ) . PHP_EOL . "\\t";
                    
                }
                
            }
            
        }
        
    }
    
}

if( $toPlaceholders ){
    
    foreach( $output as $pl_name => $out ){
        $modx->setPlaceholder( $pl_prefix . $pl_name, $out );
    }
    
    $output = array();
    
}

return implode( \'\', $output );',
    ),
  ),
  'a79fd49a7fff0380a3216bf835bf13c8' => 
  array (
    'criteria' => 
    array (
      'name' => 'num_format',
    ),
    'object' => 
    array (
      'id' => 24,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'num_format',
      'description' => 'Number format output filter',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '/*
 * numFormat snippet
 * example: [[*price:num_format]]
 */

if(strlen($input)==0) return \'\';

$input = floatval(str_replace(array(\' \',\',\'), array(\'\',\'.\'), $input));
return number_format($input,(floor($input) == $input ? 0 : 2),\'.\',\' \');',
      'locked' => 0,
      'properties' => NULL,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/*
 * numFormat snippet
 * example: [[*price:num_format]]
 */

if(strlen($input)==0) return \'\';

$input = floatval(str_replace(array(\' \',\',\'), array(\'\',\'.\'), $input));
return number_format($input,(floor($input) == $input ? 0 : 2),\'.\',\' \');',
    ),
  ),
  'b2d2e1f632ed90ce931206348802ad45' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk_curr_rate',
    ),
    'object' => 
    array (
      'id' => 25,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shk_curr_rate',
      'description' => '',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '/*
 * shk_curr_rate snippet
 * example: [[!*price:shk_curr_rate]] [[!+shk_currency]]
 */

if(!function_exists(\'shk_currency_calc\')){
    function shk_currency_calc($properties, $base_price, $currency_id, $rate_ratio = 0){
        
        $inverse = isset($properties[\'inverse\']) ? $properties[\'inverse\'] : false;//обратный перевод цены
        
        if( !$rate_ratio ){
            
            if( isset( $_SESSION[\'shk_curr_rate\'] ) && is_numeric( $_SESSION[\'shk_curr_rate\'] ) && !$inverse ){
                
                $rate_ratio = $_SESSION[\'shk_curr_rate\'];
                
            }else{
                
                if( !isset( $properties[\'currency_rate\'] ) ){
                    require_once MODX_CORE_PATH . "components/shopkeeper3/model/shopkeeper.class.php";
                    $config = Shopkeeper::getConfig( array(\'currency_rate\') );
                    $properties[\'currency_rate\'] = $config[\'currency_rate\'];
                }
                
                $rate_ratio = 1;
                
                if( $properties[\'currency_default\'] != $currency_id ){
                    
                    $rate_default = 1;
                    $rate = 1;
                    //Определяем курс по умолчанию и новый курс
                    foreach( $properties[\'currency_rate\'] as $rt ){
                        if( $rt[\'id\'] == $properties[\'currency_default\'] ){
                            $rate_default = Shopkeeper::cleanNumber( $rt[\'value\'], \'float\' );
                        }
                        else if( $rt[\'id\'] == $currency_id ){
                            $rate = Shopkeeper::cleanNumber( $rt[\'value\'], \'float\' );
                        }
                    }
                    
                    if( !$inverse ){
                        $rate_ratio = $rate_default / $rate;
                        $_SESSION[\'shk_curr_rate\'] = $rate_ratio;
                    }else{
                        $rate_ratio = $rate / $rate_default;
                    }
                    
                }
                
            }
            
        }
        
        //Считаем цену по курсу
        if( $rate_ratio ){
            
            $price = $base_price * $rate_ratio;
            $price = round( $price, ( ceil( $price ) == $price ? 0 : 2 ) );
            return $price;
        
        }else{
            return $base_price;
        }
        
    }
}

$scriptProperties = array_merge(
    array(
        \'currency_default\' => $modx->getOption( \'shk3.currency_default\', null, 1 ),
        \'currency_selected\' => $modx->getOption( \'shk3.currency_selected\', null, 0 )
    ),
    $scriptProperties
);

$output = floatval(str_replace(array(\' \',\',\'), array(\'\',\'.\'), $scriptProperties[\'input\']));
$shk_currency = !empty($_COOKIE[\'shk_currency\']) && is_numeric($_COOKIE[\'shk_currency\']) ? abs(intval($_COOKIE[\'shk_currency\'])) : $scriptProperties[\'currency_default\'];
//Если нужен всегда преевод в одну валюту
if( !empty( $scriptProperties[\'currency_selected\'] ) && $shk_currency != $scriptProperties[\'currency_selected\'] ){
    setcookie( \'shk_currency\', intval($scriptProperties[\'currency_selected\']), time()+3600*24, "/" );
    $shk_currency = intval($scriptProperties[\'currency_selected\']);
}

//Считаем цену по курсу
$output = shk_currency_calc( $scriptProperties, $output, $shk_currency );

return $output;',
      'locked' => 0,
      'properties' => NULL,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/*
 * shk_curr_rate snippet
 * example: [[!*price:shk_curr_rate]] [[!+shk_currency]]
 */

if(!function_exists(\'shk_currency_calc\')){
    function shk_currency_calc($properties, $base_price, $currency_id, $rate_ratio = 0){
        
        $inverse = isset($properties[\'inverse\']) ? $properties[\'inverse\'] : false;//обратный перевод цены
        
        if( !$rate_ratio ){
            
            if( isset( $_SESSION[\'shk_curr_rate\'] ) && is_numeric( $_SESSION[\'shk_curr_rate\'] ) && !$inverse ){
                
                $rate_ratio = $_SESSION[\'shk_curr_rate\'];
                
            }else{
                
                if( !isset( $properties[\'currency_rate\'] ) ){
                    require_once MODX_CORE_PATH . "components/shopkeeper3/model/shopkeeper.class.php";
                    $config = Shopkeeper::getConfig( array(\'currency_rate\') );
                    $properties[\'currency_rate\'] = $config[\'currency_rate\'];
                }
                
                $rate_ratio = 1;
                
                if( $properties[\'currency_default\'] != $currency_id ){
                    
                    $rate_default = 1;
                    $rate = 1;
                    //Определяем курс по умолчанию и новый курс
                    foreach( $properties[\'currency_rate\'] as $rt ){
                        if( $rt[\'id\'] == $properties[\'currency_default\'] ){
                            $rate_default = Shopkeeper::cleanNumber( $rt[\'value\'], \'float\' );
                        }
                        else if( $rt[\'id\'] == $currency_id ){
                            $rate = Shopkeeper::cleanNumber( $rt[\'value\'], \'float\' );
                        }
                    }
                    
                    if( !$inverse ){
                        $rate_ratio = $rate_default / $rate;
                        $_SESSION[\'shk_curr_rate\'] = $rate_ratio;
                    }else{
                        $rate_ratio = $rate / $rate_default;
                    }
                    
                }
                
            }
            
        }
        
        //Считаем цену по курсу
        if( $rate_ratio ){
            
            $price = $base_price * $rate_ratio;
            $price = round( $price, ( ceil( $price ) == $price ? 0 : 2 ) );
            return $price;
        
        }else{
            return $base_price;
        }
        
    }
}

$scriptProperties = array_merge(
    array(
        \'currency_default\' => $modx->getOption( \'shk3.currency_default\', null, 1 ),
        \'currency_selected\' => $modx->getOption( \'shk3.currency_selected\', null, 0 )
    ),
    $scriptProperties
);

$output = floatval(str_replace(array(\' \',\',\'), array(\'\',\'.\'), $scriptProperties[\'input\']));
$shk_currency = !empty($_COOKIE[\'shk_currency\']) && is_numeric($_COOKIE[\'shk_currency\']) ? abs(intval($_COOKIE[\'shk_currency\'])) : $scriptProperties[\'currency_default\'];
//Если нужен всегда преевод в одну валюту
if( !empty( $scriptProperties[\'currency_selected\'] ) && $shk_currency != $scriptProperties[\'currency_selected\'] ){
    setcookie( \'shk_currency\', intval($scriptProperties[\'currency_selected\']), time()+3600*24, "/" );
    $shk_currency = intval($scriptProperties[\'currency_selected\']);
}

//Считаем цену по курсу
$output = shk_currency_calc( $scriptProperties, $output, $shk_currency );

return $output;',
    ),
  ),
  '0b3525d4636c3fb13fc6b6fd4e7cd95a' => 
  array (
    'criteria' => 
    array (
      'name' => 'param_edit_table',
    ),
    'object' => 
    array (
      'id' => 26,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'param_edit_table',
      'description' => 'Print options of product (param-edit)',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '//***********************************
//Сниппет для MODx 2.x
//***********************************

/*

[[param_edit_table?
&docId=`1`
&tvName=`param1`
&tpl=`properties_table`
]]

[[param_edit_table?
&tvValue=`[[+tv.param1]]`
&tpl=`properties_table`
]]

[[param_edit_table?
&docId=`1`
&tvName=`all_width`
&postName=`w`
&tpl=`@CODE:
<select name="w">
    <option value=""></option>
    [[+inner]]
</select>
<!--tpl_separator-->
<option value="[[+field1]]"[[+selected1]]>[[+field1]]</option>
`]]

Примеры чанка:

1.

<h1>Заголовок</h1>
[[+inner]]
<!--tpl_separator-->
<div class="one">
    <img src="[[+field1]]" width="203" height="144" alt="" />
    <h3>[[+field2]]</h3>
    <p>[[+field3]]</p>
</div>

2.

<table>[[+inner]]</table>
<!--tpl_separator-->
<tr>
    [[+inner]]
</tr>
<!--tpl_separator-->
<td>[[+col_num]]. [[+field]]</td>

3.

<div class="product-options">
    [[+inner]]
</div>
<!--tpl_separator-->
<label>
    <input type="radio" class="shk_param" value="[[*idx]]__[[+field2]]" name="size__[[+id]]" onclick="SHK.additOpt(this)" [[+idx:eq=`0`:then=`checked`]] />
    [[+field1]]
</label>

*/

$docId = $modx->getOption(\'docId\',$scriptProperties,$modx->resource->get(\'id\'));
$tvName = $modx->getOption(\'tvName\',$scriptProperties,\'param\');
$s_id = $modx->getOption(\'id\',$scriptProperties,$tvName);
$tpl = $modx->getOption(\'tpl\',$scriptProperties,\'\');
$postName = $modx->getOption(\'postName\',$scriptProperties,\'none\');
$postName_arr = explode(\',\',$postName);
$tvValue = $modx->getOption(\'tvValue\',$scriptProperties,\'\');
$noEmpty = $modx->getOption(\'noEmpty\',$scriptProperties,true);
$separateCols = $modx->getOption(\'separateCols\',$scriptProperties,false);
$toPlaceholder = $modx->getOption(\'toPlaceholder\',$scriptProperties,\'\');
$minCount = $modx->getOption(\'minCount\',$scriptProperties,0);
$rowIndex = $modx->getOption(\'rowIndex\',$scriptProperties,\'\');
$defaultValue = $modx->getOption(\'defaultValue\',$scriptProperties,\'\');
$defaultTpl = $modx->getOption(\'defaultTpl\',$scriptProperties,\'\');
$placeholderPrefix = $modx->getOption(\'placeholderPrefix\',$scriptProperties,\'\');
if(!$tpl) return \'\';
$output = \'\';
$out_arr = array();

if(!function_exists(\'fetchTpl\')){
function fetchTpl($tpl){
    global $modx;
    $template = "";
    if(substr($tpl, 0, 6) == "@FILE:"){
      $tpl_file = MODX_BASE_PATH . substr($tpl, 6);
        $template = file_get_contents($tpl_file);
    }else if(substr($tpl, 0, 6) == "@CODE:"){
        $template = substr($tpl, 6);
    }else if($modx->getChunk($tpl) != ""){
        $template = $modx->getChunk($tpl);
    }else{
        $template = false;
    }
    return $template;
}
}

if(!$tvValue){
    $tv = $modx->getObject(\'modTemplateVar\',array(\'name\'=>$tvName));
    if($tv) $tvValue = $tv->getValue($docId);
}
$rowChunk = explode(\'<!--tpl_separator-->\', fetchTpl($tpl));
$fields = $tvValue ? explode(\'||\',$tvValue) : array();
if(strlen($rowIndex)>0) $fields = array_slice($fields, $rowIndex, 1);

$row_unique = uniqid();
$col_unique = uniqid();

if(count($fields)>0 && count($fields) >= $minCount){

    foreach($fields as $key => $val){
        $row = explode(\'==\',$val);
        $rowArr = array();
        foreach($row as $k => $v){
            if(!empty($v) || !$noEmpty){
                
                $index = $separateCols ? $k : 0;
                $rowArr[$index][$placeholderPrefix.\'field\'.($separateCols ? \'1\' : ($k+1))] = $v;
                
                if(isset($postName_arr[$k])) $postName = $postName_arr[$k];
                if(isset($_POST[$postName])){
                    $selected = $_POST[$postName] == $v ? \' selected="selected"\' : \'\';
                }if(isset($_GET[$postName])){
                    $selected = $_GET[$postName] == $v ? \' selected="selected"\' : \'\';
                }else{
                    $selected = isset($modx->placeholders[\'form_\'.$postName]) && $modx->placeholders[\'form_\'.$postName] == $v ? \' selected="selected"\' : \'\';
                }
                
                $rowArr[$index][\'selected\'.($separateCols ? \'1\' : ($k+1))] = $selected;
                if(!isset($rowArr[$index][$placeholderPrefix.\'inner\'])) $rowArr[$index][$placeholderPrefix.\'inner\'] = \'\';
                
                if(!empty($rowChunk[2])){
                    $colArr = array(
                        $placeholderPrefix.\'col_num\' => $k+1,
                        $placeholderPrefix.\'field\' => $v,
                        $placeholderPrefix.\'idx\' => $key,
                        $placeholderPrefix.\'num\' => $key+1
                    );
                    $chunk = $modx->newObject(\'modChunk\');
                    $chunk->fromArray(array(\'name\'=>"@INLINE-{$col_unique}",\'snippet\'=>$rowChunk[2]));
                    $chunk->setCacheable(false);
                    
                    $rowArr[$index][$placeholderPrefix.\'inner\'] .= $chunk->process($colArr);
                    
                }
            }
        }
        unset($k,$v);
        
        //echo \'<pre>\'; print_r($rowArr); echo \'</pre>\'; exit;
        
        foreach($rowArr as $k => $v){
            $chunk = $modx->newObject(\'modChunk\');
            $chunk->fromArray(array(\'name\'=>"@INLINE-{$row_unique}",\'snippet\'=>(isset($rowChunk[1]) ? $rowChunk[1] : \'\')));
            $chunk->setCacheable(false);
            $v[$placeholderPrefix.\'idx\'] = $key;
            $v[$placeholderPrefix.\'num\'] = $key+1;
            $v[$placeholderPrefix.\'id\'] = $docId;
            $temp_out = $chunk->process($v);
            if(!$noEmpty || ($temp_out != $rowChunk[1])){
                if(!isset($out_arr[$k])) $out_arr[$k] = \'\';
                $out_arr[$k] .= $temp_out;
            }
        }
        unset($k,$v);
    }
    unset($key,$val);
    
    //echo \'<pre>\'; print_r($out_arr); echo \'</pre>\'; exit;
    
    if(strlen($out_arr[0])>0){
        $chunk = $modx->newObject(\'modChunk\');
        $chunk->fromArray(array(\'name\'=>"@INLINE-".uniqid(),\'snippet\'=>(isset($rowChunk[0]) ? $rowChunk[0] : \'\')));
        $chunk->setCacheable(false);
        $out_arr[0] = $chunk->process(array($placeholderPrefix.\'inner\'=>$out_arr[0]));
        $output = $out_arr[0];
        
        //Ставим отдельные плейсхолдеры для всех колонок таблицы
        if($separateCols){
            array_shift($out_arr);
            array_shift($postName_arr);
            foreach($out_arr as $key => $val){
                $temp_id = isset($postName_arr[$key]) ? $postName_arr[$key] : $key+1;
                $modx->setPlaceholder($s_id.\'_\'.$temp_id, $val);
            }
        }
        
    }

}else if($defaultValue && $defaultTpl){
    
    $output = $modx->getChunk($defaultTpl, array(\'value\'=>$defaultValue));
    
}

if($output && $toPlaceholder){
    $modx->setPlaceholder($toPlaceholder, $output);
    $output = \'\';
}

return $output;',
      'locked' => 0,
      'properties' => NULL,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '//***********************************
//Сниппет для MODx 2.x
//***********************************

/*

[[param_edit_table?
&docId=`1`
&tvName=`param1`
&tpl=`properties_table`
]]

[[param_edit_table?
&tvValue=`[[+tv.param1]]`
&tpl=`properties_table`
]]

[[param_edit_table?
&docId=`1`
&tvName=`all_width`
&postName=`w`
&tpl=`@CODE:
<select name="w">
    <option value=""></option>
    [[+inner]]
</select>
<!--tpl_separator-->
<option value="[[+field1]]"[[+selected1]]>[[+field1]]</option>
`]]

Примеры чанка:

1.

<h1>Заголовок</h1>
[[+inner]]
<!--tpl_separator-->
<div class="one">
    <img src="[[+field1]]" width="203" height="144" alt="" />
    <h3>[[+field2]]</h3>
    <p>[[+field3]]</p>
</div>

2.

<table>[[+inner]]</table>
<!--tpl_separator-->
<tr>
    [[+inner]]
</tr>
<!--tpl_separator-->
<td>[[+col_num]]. [[+field]]</td>

3.

<div class="product-options">
    [[+inner]]
</div>
<!--tpl_separator-->
<label>
    <input type="radio" class="shk_param" value="[[*idx]]__[[+field2]]" name="size__[[+id]]" onclick="SHK.additOpt(this)" [[+idx:eq=`0`:then=`checked`]] />
    [[+field1]]
</label>

*/

$docId = $modx->getOption(\'docId\',$scriptProperties,$modx->resource->get(\'id\'));
$tvName = $modx->getOption(\'tvName\',$scriptProperties,\'param\');
$s_id = $modx->getOption(\'id\',$scriptProperties,$tvName);
$tpl = $modx->getOption(\'tpl\',$scriptProperties,\'\');
$postName = $modx->getOption(\'postName\',$scriptProperties,\'none\');
$postName_arr = explode(\',\',$postName);
$tvValue = $modx->getOption(\'tvValue\',$scriptProperties,\'\');
$noEmpty = $modx->getOption(\'noEmpty\',$scriptProperties,true);
$separateCols = $modx->getOption(\'separateCols\',$scriptProperties,false);
$toPlaceholder = $modx->getOption(\'toPlaceholder\',$scriptProperties,\'\');
$minCount = $modx->getOption(\'minCount\',$scriptProperties,0);
$rowIndex = $modx->getOption(\'rowIndex\',$scriptProperties,\'\');
$defaultValue = $modx->getOption(\'defaultValue\',$scriptProperties,\'\');
$defaultTpl = $modx->getOption(\'defaultTpl\',$scriptProperties,\'\');
$placeholderPrefix = $modx->getOption(\'placeholderPrefix\',$scriptProperties,\'\');
if(!$tpl) return \'\';
$output = \'\';
$out_arr = array();

if(!function_exists(\'fetchTpl\')){
function fetchTpl($tpl){
    global $modx;
    $template = "";
    if(substr($tpl, 0, 6) == "@FILE:"){
      $tpl_file = MODX_BASE_PATH . substr($tpl, 6);
        $template = file_get_contents($tpl_file);
    }else if(substr($tpl, 0, 6) == "@CODE:"){
        $template = substr($tpl, 6);
    }else if($modx->getChunk($tpl) != ""){
        $template = $modx->getChunk($tpl);
    }else{
        $template = false;
    }
    return $template;
}
}

if(!$tvValue){
    $tv = $modx->getObject(\'modTemplateVar\',array(\'name\'=>$tvName));
    if($tv) $tvValue = $tv->getValue($docId);
}
$rowChunk = explode(\'<!--tpl_separator-->\', fetchTpl($tpl));
$fields = $tvValue ? explode(\'||\',$tvValue) : array();
if(strlen($rowIndex)>0) $fields = array_slice($fields, $rowIndex, 1);

$row_unique = uniqid();
$col_unique = uniqid();

if(count($fields)>0 && count($fields) >= $minCount){

    foreach($fields as $key => $val){
        $row = explode(\'==\',$val);
        $rowArr = array();
        foreach($row as $k => $v){
            if(!empty($v) || !$noEmpty){
                
                $index = $separateCols ? $k : 0;
                $rowArr[$index][$placeholderPrefix.\'field\'.($separateCols ? \'1\' : ($k+1))] = $v;
                
                if(isset($postName_arr[$k])) $postName = $postName_arr[$k];
                if(isset($_POST[$postName])){
                    $selected = $_POST[$postName] == $v ? \' selected="selected"\' : \'\';
                }if(isset($_GET[$postName])){
                    $selected = $_GET[$postName] == $v ? \' selected="selected"\' : \'\';
                }else{
                    $selected = isset($modx->placeholders[\'form_\'.$postName]) && $modx->placeholders[\'form_\'.$postName] == $v ? \' selected="selected"\' : \'\';
                }
                
                $rowArr[$index][\'selected\'.($separateCols ? \'1\' : ($k+1))] = $selected;
                if(!isset($rowArr[$index][$placeholderPrefix.\'inner\'])) $rowArr[$index][$placeholderPrefix.\'inner\'] = \'\';
                
                if(!empty($rowChunk[2])){
                    $colArr = array(
                        $placeholderPrefix.\'col_num\' => $k+1,
                        $placeholderPrefix.\'field\' => $v,
                        $placeholderPrefix.\'idx\' => $key,
                        $placeholderPrefix.\'num\' => $key+1
                    );
                    $chunk = $modx->newObject(\'modChunk\');
                    $chunk->fromArray(array(\'name\'=>"@INLINE-{$col_unique}",\'snippet\'=>$rowChunk[2]));
                    $chunk->setCacheable(false);
                    
                    $rowArr[$index][$placeholderPrefix.\'inner\'] .= $chunk->process($colArr);
                    
                }
            }
        }
        unset($k,$v);
        
        //echo \'<pre>\'; print_r($rowArr); echo \'</pre>\'; exit;
        
        foreach($rowArr as $k => $v){
            $chunk = $modx->newObject(\'modChunk\');
            $chunk->fromArray(array(\'name\'=>"@INLINE-{$row_unique}",\'snippet\'=>(isset($rowChunk[1]) ? $rowChunk[1] : \'\')));
            $chunk->setCacheable(false);
            $v[$placeholderPrefix.\'idx\'] = $key;
            $v[$placeholderPrefix.\'num\'] = $key+1;
            $v[$placeholderPrefix.\'id\'] = $docId;
            $temp_out = $chunk->process($v);
            if(!$noEmpty || ($temp_out != $rowChunk[1])){
                if(!isset($out_arr[$k])) $out_arr[$k] = \'\';
                $out_arr[$k] .= $temp_out;
            }
        }
        unset($k,$v);
    }
    unset($key,$val);
    
    //echo \'<pre>\'; print_r($out_arr); echo \'</pre>\'; exit;
    
    if(strlen($out_arr[0])>0){
        $chunk = $modx->newObject(\'modChunk\');
        $chunk->fromArray(array(\'name\'=>"@INLINE-".uniqid(),\'snippet\'=>(isset($rowChunk[0]) ? $rowChunk[0] : \'\')));
        $chunk->setCacheable(false);
        $out_arr[0] = $chunk->process(array($placeholderPrefix.\'inner\'=>$out_arr[0]));
        $output = $out_arr[0];
        
        //Ставим отдельные плейсхолдеры для всех колонок таблицы
        if($separateCols){
            array_shift($out_arr);
            array_shift($postName_arr);
            foreach($out_arr as $key => $val){
                $temp_id = isset($postName_arr[$key]) ? $postName_arr[$key] : $key+1;
                $modx->setPlaceholder($s_id.\'_\'.$temp_id, $val);
            }
        }
        
    }

}else if($defaultValue && $defaultTpl){
    
    $output = $modx->getChunk($defaultTpl, array(\'value\'=>$defaultValue));
    
}

if($output && $toPlaceholder){
    $modx->setPlaceholder($toPlaceholder, $output);
    $output = \'\';
}

return $output;',
    ),
  ),
  '5b1904eb2c42e94ec38bdeba5e7799c7' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk_sitemap',
    ),
    'object' => 
    array (
      'id' => 27,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shk_sitemap',
      'description' => 'Create sitemap.xml for catalog',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '/**
 * snippet shk_sitemap
 *
 * @author slaad
 *
 */

/*

http://modx-shopkeeper.ru/forum/viewtopic.php?pid=20545#p20545

Examples

1. Only resources (one or more contexts):

[[shk_sitemap?
&packageNames=`modResource`
&classNames=`modResource`
]]

2. Resources and shop package (Shopkeeper), two contexts:

[[shk_sitemap?
&packageNames=`modResource,shop`
&classNames=`modResource,ShopContent`
&contexts=`web,catalog`
]]
3. Excluding resources 
  
excluding resources with ids 17,23,31,16:

[[shk_sitemap?
&packageNames=`modResource,shop`
&classNames=`modResource,ShopContent`
&contexts=`web,catalog`
&excludeModResIds=`17,23,31,16`    
]]
 and excluding resources with ids 17,23,31,16 and 1 level childs of resources with ids 17,11,23,14
[[shk_sitemap?
&packageNames=`modResource,shop`
&classNames=`modResource,ShopContent`
&contexts=`web,catalog`
&excludeModResIds=`17,23,31,16`
&excludeModContIds=`17,11,23,14`
]]
 
  
  
  
*/

$config =  array(
    \'packageNames\' => \'modResource,shop\',
    \'classNames\' => \'modResource,ShopContent\',
    \'contexts\' => \'web,catalog\',
    \'site_url\'=> $modx->getOption(\'site_url\'),
    \'site_start\'=> $modx->getOption(\'site_start\', null, 1),
    \'excludeModResIds\'=>\'17,23,31,16,19,20\',
    \'excludeModContIds\'=>\'17,11,23,14\'
);
$contentType = $modx->getObject(\'modContentType\',array(\'name\'=>\'HTML\'));
$config[\'urlSuffix\']= $contentType->getExtension();
$config[\'containerSuffix\']=$modx->getOption(\'container_suffix\');
$config = array_merge( $config, $scriptProperties );


$packageNames = explode(\',\',$config[\'packageNames\']);
$classNames = explode(\',\',$config[\'classNames\']);
$contexts = explode(\',\',$config[\'contexts\']);

$output = \'<?xml version="1.0" encoding="UTF-8"
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\' . PHP_EOL;

if(!function_exists(\'getMapQuery\')){
    function getMapQuery($className,$select,$where){
        global $modx;
        $query = $modx->newQuery($className);
        $query->select($select);
        $query->where($where);
        $query->sortby(\'id\',\'ASC\');
        if ( $query->prepare() && $query->stmt->execute() ){
            $query_out= array();
            //$modx->log(modX::LOG_LEVEL_ERROR, $query->toSql());
            $query_out = $query->stmt->fetchAll(PDO::FETCH_ASSOC);

            foreach($query_out as $r){
                if (!isset($resources[$r[\'id\']])) $resources[$r[\'id\']]=array();
                foreach ($select as $s){
                    $resources[$r[\'id\']][$s] = $r[$s];
                }
            }
        }
        return $resources;
    }
}
if (!function_exists(\'datediff\')) {
    /**
     * @param string $interval Can be:
    yyyy - Number of full years
    q - Number of full quarters
    m - Number of full months
    y - Difference between day numbers
    (eg 1st Jan 2004 is "1", the first day. 2nd Feb 2003 is "33". The
    datediff is "-32".)
    d - Number of full days
    w - Number of full weekdays
    ww - Number of full weeks
    h - Number of full hours
    n - Number of full minutes
    s   - Number of full seconds (default)
     * @param $datefrom
     * @param $dateto
     * @param bool $using_timestamps
     * @return float|int|string
     * @package googlesitemap
     */
    function datediff($interval, $datefrom, $dateto, $using_timestamps = false) {
        if (!$using_timestamps) {
            $datefrom = strtotime($datefrom, 0);
            $dateto = strtotime($dateto, 0);
        }
        $difference = $dateto - $datefrom; /* Difference in seconds */
        switch($interval) {
            case \'yyyy\': /* Number of full years */
                $years_difference = floor($difference / 31536000);
                if (mktime(date("H", $datefrom), date("i", $datefrom), date("s", $datefrom), date("n", $datefrom), date("j", $datefrom), date("Y", $datefrom)+$years_difference) > $dateto) {
                    $years_difference--;
                }
                if (mktime(date("H", $dateto), date("i", $dateto), date("s", $dateto), date("n", $dateto), date("j", $dateto), date("Y", $dateto)-($years_difference+1)) > $datefrom) {
                    $years_difference++;
                }
                $datediff = $years_difference;
                break;

            case \'q\': /* Number of full quarters */
                $quarters_difference = floor($difference / 8035200);
                while (mktime(date("H", $datefrom), date("i", $datefrom), date("s", $datefrom), date("n", $datefrom)+($quarters_difference*3), date("j", $dateto), date("Y", $datefrom)) < $dateto) {
                    $quarters_difference++;
                }
                $quarters_difference--;
                $datediff = $quarters_difference;
                break;

            case \'m\': /* Number of full months */
                $months_difference = floor($difference / 2678400);
                while (mktime(date("H", $datefrom), date("i", $datefrom), date("s", $datefrom), date("n", $datefrom)+($months_difference), date("j", $dateto), date("Y", $datefrom)) < $dateto) {
                    $months_difference++;
                }
                $months_difference--;
                $datediff = $months_difference;
                break;

            case \'y\': /* Difference between day numbers */
                $datediff = date(\'z\',$dateto) - date(\'z\',$datefrom);
                break;

            case \'d\': /* Number of full days */
                $datediff = floor($difference / 86400);
                break;

            case \'w\': /* Number of full weekdays */
                $days_difference = floor($difference / 86400);
                $weeks_difference = floor($days_difference / 7); /* Complete weeks */
                $first_day = date(\'w\', $datefrom);
                $days_remainder = floor($days_difference % 7);
                /* Do we have a Saturday or Sunday in the remainder? */
                $odd_days = $first_day + $days_remainder;
                if ($odd_days > 7) { /* Sunday */
                    $days_remainder--;
                }
                if ($odd_days > 6) { /* Saturday */
                    $days_remainder--;
                }
                $datediff = ($weeks_difference * 5) + $days_remainder;
                break;

            case \'ww\': /* Number of full weeks */
                $datediff = floor($difference / 604800);
                break;

            case \'h\': /* Number of full hours */
                $datediff = floor($difference / 3600);
                break;

            case \'n\': /* Number of full minutes */
                $datediff = floor($difference / 60);
                break;

            default: /* Number of full seconds (default) */
                $datediff = $difference;
                break;
        }
        return $datediff;
    }
}


foreach ( $packageNames as $key => $packageName ){

    $parentName = $packageName == \'modResource\' ? "parent" : "resource_id";
    $select = array(\'id\',\'alias\',\'editedon\',\'createdon\',$parentName);
    if( $packageName != \'modResource\' ){
        $modelpath = $modx->getOption(\'core_path\') . \'components/\' . $packageName . \'/model/\';
        $modx->addPackage($packageName, $modelpath);
    }
    else{
        $select = array_merge( $select, array(\'context_key\',\'isfolder\') );
    }

    $where=array( \'published\' => 1 );
    if($config[\'excludeModResIds\'] && $packageName == \'modResource\'){
        $ids=array(\'id:NOT IN\' => explode(\',\',$config[\'excludeModResIds\'] ));
        array_push($where,$ids);
    }
    if($config[\'excludeModContIds\']&& $packageName == \'modResource\'){
        $ids=array(\'parent:NOT IN\' => explode(\',\',$config[\'excludeModContIds\'] ));
        array_push($where,$ids);
    }
    $resources = getMapQuery($classNames[$key],$select,$where);
    if(!empty($resources)){
        foreach ( $resources as $resource ){
            if(!empty($resource[\'alias\'])){
                if (!isset($resource[\'context_key\'])) {
                    $resource[\'context_key\'] = !empty( $contexts[$key] ) ? $contexts[$key] : $contexts[0];
                }
                if ( $resource[$parentName] != 0 ){
                    $url = $modx->makeUrl($resource[$parentName],$resource[\'context_key\'],\'\',\'full\');
                }
                else{
                    $url = $config[\'site_url\'];
                }

                $url .=substr($url, -1)==\'/\' ? $resource[\'alias\'] : \'/\'.$resource[\'alias\'];
                $url .= !empty( $resource[\'isfolder\'] ) ? $config[\'containerSuffix\'] : $config[\'urlSuffix\'];

                if ($packageName == \'modResource\'&& $resource[\'id\']==$config[\'site_start\']){
                    $url=$config[\'site_url\'];
                }

                $date = !empty( $resource[\'editedon\'] ) ? $resource[\'editedon\'] : $resource[\'createdon\'];
                $date = strftime( \'%Y-%m-%d\', $date );
                $date = date("Y-m-d", strtotime($date));

                /* Get the date difference */
                $datediff = datediff("d", $date, date("Y-m-d"));
                if ($datediff <=1) {
                    $priority = \'1.0\';
                    $update = \'daily\';
                } elseif (($datediff >1) && ($datediff<=7)) {
                    $priority = \'0.75\';
                    $update = \'weekly\';
                } elseif (($datediff >7) && ($datediff<=30)) {
                    $priority = \'0.50\';
                    $update = \'weekly\';
                } else {
                    $priority = \'0.25\';
                    $update = \'monthly\';
                }

                $output .= "
            <url>
                <loc>{$url}</loc>
                <lastmod>{$date}</lastmod>
                <priority>{$priority}</priority>
                <changefreq>{$update}</changefreq>
            </url>";
            }
        }
    }
}
unset($key);

$output .= PHP_EOL . "</urlset>";

return $output;',
      'locked' => 0,
      'properties' => NULL,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/**
 * snippet shk_sitemap
 *
 * @author slaad
 *
 */

/*

http://modx-shopkeeper.ru/forum/viewtopic.php?pid=20545#p20545

Examples

1. Only resources (one or more contexts):

[[shk_sitemap?
&packageNames=`modResource`
&classNames=`modResource`
]]

2. Resources and shop package (Shopkeeper), two contexts:

[[shk_sitemap?
&packageNames=`modResource,shop`
&classNames=`modResource,ShopContent`
&contexts=`web,catalog`
]]
3. Excluding resources 
  
excluding resources with ids 17,23,31,16:

[[shk_sitemap?
&packageNames=`modResource,shop`
&classNames=`modResource,ShopContent`
&contexts=`web,catalog`
&excludeModResIds=`17,23,31,16`    
]]
 and excluding resources with ids 17,23,31,16 and 1 level childs of resources with ids 17,11,23,14
[[shk_sitemap?
&packageNames=`modResource,shop`
&classNames=`modResource,ShopContent`
&contexts=`web,catalog`
&excludeModResIds=`17,23,31,16`
&excludeModContIds=`17,11,23,14`
]]
 
  
  
  
*/

$config =  array(
    \'packageNames\' => \'modResource,shop\',
    \'classNames\' => \'modResource,ShopContent\',
    \'contexts\' => \'web,catalog\',
    \'site_url\'=> $modx->getOption(\'site_url\'),
    \'site_start\'=> $modx->getOption(\'site_start\', null, 1),
    \'excludeModResIds\'=>\'17,23,31,16,19,20\',
    \'excludeModContIds\'=>\'17,11,23,14\'
);
$contentType = $modx->getObject(\'modContentType\',array(\'name\'=>\'HTML\'));
$config[\'urlSuffix\']= $contentType->getExtension();
$config[\'containerSuffix\']=$modx->getOption(\'container_suffix\');
$config = array_merge( $config, $scriptProperties );


$packageNames = explode(\',\',$config[\'packageNames\']);
$classNames = explode(\',\',$config[\'classNames\']);
$contexts = explode(\',\',$config[\'contexts\']);

$output = \'<?xml version="1.0" encoding="UTF-8"
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\' . PHP_EOL;

if(!function_exists(\'getMapQuery\')){
    function getMapQuery($className,$select,$where){
        global $modx;
        $query = $modx->newQuery($className);
        $query->select($select);
        $query->where($where);
        $query->sortby(\'id\',\'ASC\');
        if ( $query->prepare() && $query->stmt->execute() ){
            $query_out= array();
            //$modx->log(modX::LOG_LEVEL_ERROR, $query->toSql());
            $query_out = $query->stmt->fetchAll(PDO::FETCH_ASSOC);

            foreach($query_out as $r){
                if (!isset($resources[$r[\'id\']])) $resources[$r[\'id\']]=array();
                foreach ($select as $s){
                    $resources[$r[\'id\']][$s] = $r[$s];
                }
            }
        }
        return $resources;
    }
}
if (!function_exists(\'datediff\')) {
    /**
     * @param string $interval Can be:
    yyyy - Number of full years
    q - Number of full quarters
    m - Number of full months
    y - Difference between day numbers
    (eg 1st Jan 2004 is "1", the first day. 2nd Feb 2003 is "33". The
    datediff is "-32".)
    d - Number of full days
    w - Number of full weekdays
    ww - Number of full weeks
    h - Number of full hours
    n - Number of full minutes
    s   - Number of full seconds (default)
     * @param $datefrom
     * @param $dateto
     * @param bool $using_timestamps
     * @return float|int|string
     * @package googlesitemap
     */
    function datediff($interval, $datefrom, $dateto, $using_timestamps = false) {
        if (!$using_timestamps) {
            $datefrom = strtotime($datefrom, 0);
            $dateto = strtotime($dateto, 0);
        }
        $difference = $dateto - $datefrom; /* Difference in seconds */
        switch($interval) {
            case \'yyyy\': /* Number of full years */
                $years_difference = floor($difference / 31536000);
                if (mktime(date("H", $datefrom), date("i", $datefrom), date("s", $datefrom), date("n", $datefrom), date("j", $datefrom), date("Y", $datefrom)+$years_difference) > $dateto) {
                    $years_difference--;
                }
                if (mktime(date("H", $dateto), date("i", $dateto), date("s", $dateto), date("n", $dateto), date("j", $dateto), date("Y", $dateto)-($years_difference+1)) > $datefrom) {
                    $years_difference++;
                }
                $datediff = $years_difference;
                break;

            case \'q\': /* Number of full quarters */
                $quarters_difference = floor($difference / 8035200);
                while (mktime(date("H", $datefrom), date("i", $datefrom), date("s", $datefrom), date("n", $datefrom)+($quarters_difference*3), date("j", $dateto), date("Y", $datefrom)) < $dateto) {
                    $quarters_difference++;
                }
                $quarters_difference--;
                $datediff = $quarters_difference;
                break;

            case \'m\': /* Number of full months */
                $months_difference = floor($difference / 2678400);
                while (mktime(date("H", $datefrom), date("i", $datefrom), date("s", $datefrom), date("n", $datefrom)+($months_difference), date("j", $dateto), date("Y", $datefrom)) < $dateto) {
                    $months_difference++;
                }
                $months_difference--;
                $datediff = $months_difference;
                break;

            case \'y\': /* Difference between day numbers */
                $datediff = date(\'z\',$dateto) - date(\'z\',$datefrom);
                break;

            case \'d\': /* Number of full days */
                $datediff = floor($difference / 86400);
                break;

            case \'w\': /* Number of full weekdays */
                $days_difference = floor($difference / 86400);
                $weeks_difference = floor($days_difference / 7); /* Complete weeks */
                $first_day = date(\'w\', $datefrom);
                $days_remainder = floor($days_difference % 7);
                /* Do we have a Saturday or Sunday in the remainder? */
                $odd_days = $first_day + $days_remainder;
                if ($odd_days > 7) { /* Sunday */
                    $days_remainder--;
                }
                if ($odd_days > 6) { /* Saturday */
                    $days_remainder--;
                }
                $datediff = ($weeks_difference * 5) + $days_remainder;
                break;

            case \'ww\': /* Number of full weeks */
                $datediff = floor($difference / 604800);
                break;

            case \'h\': /* Number of full hours */
                $datediff = floor($difference / 3600);
                break;

            case \'n\': /* Number of full minutes */
                $datediff = floor($difference / 60);
                break;

            default: /* Number of full seconds (default) */
                $datediff = $difference;
                break;
        }
        return $datediff;
    }
}


foreach ( $packageNames as $key => $packageName ){

    $parentName = $packageName == \'modResource\' ? "parent" : "resource_id";
    $select = array(\'id\',\'alias\',\'editedon\',\'createdon\',$parentName);
    if( $packageName != \'modResource\' ){
        $modelpath = $modx->getOption(\'core_path\') . \'components/\' . $packageName . \'/model/\';
        $modx->addPackage($packageName, $modelpath);
    }
    else{
        $select = array_merge( $select, array(\'context_key\',\'isfolder\') );
    }

    $where=array( \'published\' => 1 );
    if($config[\'excludeModResIds\'] && $packageName == \'modResource\'){
        $ids=array(\'id:NOT IN\' => explode(\',\',$config[\'excludeModResIds\'] ));
        array_push($where,$ids);
    }
    if($config[\'excludeModContIds\']&& $packageName == \'modResource\'){
        $ids=array(\'parent:NOT IN\' => explode(\',\',$config[\'excludeModContIds\'] ));
        array_push($where,$ids);
    }
    $resources = getMapQuery($classNames[$key],$select,$where);
    if(!empty($resources)){
        foreach ( $resources as $resource ){
            if(!empty($resource[\'alias\'])){
                if (!isset($resource[\'context_key\'])) {
                    $resource[\'context_key\'] = !empty( $contexts[$key] ) ? $contexts[$key] : $contexts[0];
                }
                if ( $resource[$parentName] != 0 ){
                    $url = $modx->makeUrl($resource[$parentName],$resource[\'context_key\'],\'\',\'full\');
                }
                else{
                    $url = $config[\'site_url\'];
                }

                $url .=substr($url, -1)==\'/\' ? $resource[\'alias\'] : \'/\'.$resource[\'alias\'];
                $url .= !empty( $resource[\'isfolder\'] ) ? $config[\'containerSuffix\'] : $config[\'urlSuffix\'];

                if ($packageName == \'modResource\'&& $resource[\'id\']==$config[\'site_start\']){
                    $url=$config[\'site_url\'];
                }

                $date = !empty( $resource[\'editedon\'] ) ? $resource[\'editedon\'] : $resource[\'createdon\'];
                $date = strftime( \'%Y-%m-%d\', $date );
                $date = date("Y-m-d", strtotime($date));

                /* Get the date difference */
                $datediff = datediff("d", $date, date("Y-m-d"));
                if ($datediff <=1) {
                    $priority = \'1.0\';
                    $update = \'daily\';
                } elseif (($datediff >1) && ($datediff<=7)) {
                    $priority = \'0.75\';
                    $update = \'weekly\';
                } elseif (($datediff >7) && ($datediff<=30)) {
                    $priority = \'0.50\';
                    $update = \'weekly\';
                } else {
                    $priority = \'0.25\';
                    $update = \'monthly\';
                }

                $output .= "
            <url>
                <loc>{$url}</loc>
                <lastmod>{$date}</lastmod>
                <priority>{$priority}</priority>
                <changefreq>{$update}</changefreq>
            </url>";
            }
        }
    }
}
unset($key);

$output .= PHP_EOL . "</urlset>";

return $output;',
    ),
  ),
  '64bb6429ce2ba7c6237c5723c2506beb' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk_render_tv',
    ),
    'object' => 
    array (
      'id' => 28,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shk_render_tv',
      'description' => 'Render parameters for products as checkbox, radio, select.',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'snippet' => '/*

shk_render_tv

[[*param1:shk_render_tv=`shk_select`]]

[[*param1:shk_render_tv=`shk_checkbox`]]

[[*param1:shk_render_tv=`shk_radio`]]

[[shk_render_tv?input=`[[+tv.param1]]`&options=`shk_select`&resourceId=`[[+id]]`]]

*/

$input = $modx->getOption(\'input\',$scriptProperties,\'\');
$options = $modx->getOption(\'options\',$scriptProperties,\'shk_select\');
$resourceId = $modx->getOption(\'resourceId\',$scriptProperties,$modx->resource->id);
$tv_name = $modx->getOption(\'name\',$scriptProperties,\'tv\');
$wraptag = $modx->getOption(\'wraptag\',$scriptProperties,\'div\');
$first_selected = $modx->getOption(\'first_selected\',$scriptProperties,true);

$output = \'\';

if($input){
    
    $tv = $modx->newObject(\'modTemplateVar\');
    $tv->set(\'name\', $tv_name);
    $tv->set(\'display\', $options);
    $tv->set(\'value\', $input);
    
    $params = array(
        \'id\' => $resourceId,
        \'param_name\' => $tv_name,
        \'wraptag\' => $wraptag,
        \'first_selected\' => $first_selected,
        \'function\' => \'SHK.additOpt(this)\'
    );
    $outputRenderPaths = $tv->getRenderDirectories(\'OnTVOutputRenderList\',\'output\');
    
    $value = $tv->prepareOutput($input);
    $output = $tv->getRender($params, $value, $outputRenderPaths, \'output\', $resourceId, $options);
    
}

return $output;',
      'locked' => 0,
      'properties' => NULL,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/*

shk_render_tv

[[*param1:shk_render_tv=`shk_select`]]

[[*param1:shk_render_tv=`shk_checkbox`]]

[[*param1:shk_render_tv=`shk_radio`]]

[[shk_render_tv?input=`[[+tv.param1]]`&options=`shk_select`&resourceId=`[[+id]]`]]

*/

$input = $modx->getOption(\'input\',$scriptProperties,\'\');
$options = $modx->getOption(\'options\',$scriptProperties,\'shk_select\');
$resourceId = $modx->getOption(\'resourceId\',$scriptProperties,$modx->resource->id);
$tv_name = $modx->getOption(\'name\',$scriptProperties,\'tv\');
$wraptag = $modx->getOption(\'wraptag\',$scriptProperties,\'div\');
$first_selected = $modx->getOption(\'first_selected\',$scriptProperties,true);

$output = \'\';

if($input){
    
    $tv = $modx->newObject(\'modTemplateVar\');
    $tv->set(\'name\', $tv_name);
    $tv->set(\'display\', $options);
    $tv->set(\'value\', $input);
    
    $params = array(
        \'id\' => $resourceId,
        \'param_name\' => $tv_name,
        \'wraptag\' => $wraptag,
        \'first_selected\' => $first_selected,
        \'function\' => \'SHK.additOpt(this)\'
    );
    $outputRenderPaths = $tv->getRenderDirectories(\'OnTVOutputRenderList\',\'output\');
    
    $value = $tv->prepareOutput($input);
    $output = $tv->getRender($params, $value, $outputRenderPaths, \'output\', $resourceId, $options);
    
}

return $output;',
    ),
  ),
  '960bcd508ab5d149dd748e9802f5f401' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk_contextSwitch',
    ),
    'object' => 
    array (
      'id' => 6,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shk_contextSwitch',
      'description' => 'Switch to catalog context.',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'plugincode' => '/*

 plugin contextSwitch
 
 System event: OnHandleRequest, OnPageNotFound, OnWebPageComplete

*/

//ini_set( \'display_errors\', 1 );
//error_reporting(E_ALL);

if($modx->context->get(\'key\') == \'mgr\') return \'\';

$prodPackageName = $modx->getOption(\'prodPackageName\', $scriptProperties, \'\');//shop
$prodClassName = $modx->getOption(\'prodClassName\', $scriptProperties, \'\');//ShopContent
$prodTemplateId = $modx->getOption(\'prodTemplateId\', $scriptProperties, 1);
$debug = $modx->getOption(\'debug\', $scriptProperties, 0);
$cacheOptions = array(
    xPDO::OPT_CACHE_KEY => $modx->getOption(\'cache_resource_key\', $scriptProperties, \'resource\'),
    xPDO::OPT_CACHE_HANDLER => $modx->getOption(\'cache_resource_handler\', $scriptProperties, \'xPDOFileCache\'),
    xPDO::OPT_CACHE_EXPIRES => (integer) $modx->getOption(\'cache_resource_expires\', $scriptProperties, 0),
    xPDO::OPT_CACHE_FORMAT => (integer) $modx->getOption(\'cache_resource_format\', $scriptProperties, xPDOCacheManager::CACHE_PHP),
    xPDO::OPT_CACHE_ATTEMPTS => (integer) $modx->cacheManager->getOption(\'cache_resource_attempts\', null, 1),
    xPDO::OPT_CACHE_ATTEMPT_DELAY => (integer) $modx->cacheManager->getOption(\'cache_resource_attempt_delay\', null, 1000)
);

switch($modx->event->name){
    
    case "OnHandleRequest":
        
        $cntxt_param = $modx->getOption(\'context_param_alias\', null, \'c\');
        $request_param_id = $modx->getOption(\'request_param_id\', null, \'id\');
        $friendly_urls = $modx->getOption(\'friendly_urls\', null, true);
        $container_suffix = $modx->getOption(\'container_suffix\', null, \'\');
        $catalog_id = $modx->getOption(\'catalog_id\',$scriptProperties,0);
        $context_key = $modx->getOption(\'context_key\',$scriptProperties,\'\');
        $site_start = $modx->getOption(\'site_start\', null, 1);
        $request_uri = substr($_SERVER[\'REQUEST_URI\'],0,1)==\'/\' ? substr($_SERVER[\'REQUEST_URI\'],1) : $_SERVER[\'REQUEST_URI\'];
        if( strpos( $request_uri, \'/\' ) !== false ){
            $lang_key = substr( $request_uri, 0, strpos( $request_uri, \'/\' ) );
        }else{
            $lang_key = $request_uri;
        }
        
        if( !$context_key ) return \'\';
        
        if( $modx->config[\'friendly_urls\'] ){
            
            if( $request_uri ){
                
                $contentType = $modx->getObject(\'modContentType\',array(\'name\'=>\'HTML\'));
                $html_ext = $contentType->getExtension();
                
                $base_dir_alias = current( explode( \'/\', $request_uri ) );
                if( strlen( $container_suffix ) > 1 && strpos( $base_dir_alias, $container_suffix ) === false ){
                    $base_dir_alias .= $container_suffix;
                }
                if( !$container_suffix && $html_ext ){
                    $base_dir_alias .= $html_ext;
                }
                
                $context_child_ids = $modx->getChildIds( 0, 1, array( \'context\' => $context_key ) );
                
                //Проверяем нужно ли переключать контекст
                $switch_action = false;
                foreach( $context_child_ids as $id ){
                    $temp_url = basename( $modx->makeURL( $id,$context_key, \'\', \'abs\' ) );
                    if( $temp_url == $base_dir_alias ){
                        $switch_action = true;
                        break;
                    }
                }
                
                if( $switch_action ){
                    $modx->reloadContext( $context_key );
                    $modx->switchContext( $context_key );
                    $modx->config[\'site_start\'] = $site_start;
                    $modx->setPlaceholder( \'context_key\', $context_key );
                }
                
            }
            
        }else{
            
            $requestId = !empty($_REQUEST[$request_param_id]) && is_numeric($_REQUEST[$request_param_id]) ? $_REQUEST[$request_param_id] : 0;
            if(!$requestId) return \'\';
            $resource = $modx->getObject( \'modResource\', $requestId );
            if( $resource && $resource->get(\'context_key\') == $context_key ){
                $modx->reloadContext( $context_key );
                $modx->switchContext( $context_key );
                $modx->config[\'site_start\'] = $site_start;
                $modx->setPlaceholder( \'context_key\', $context_key );
            }
            
        }
    
    break;
    case "OnPageNotFound":
        
        if(!$prodClassName || $prodClassName==\'modResource\') break;
        
        $container_suffix = $modx->getOption(\'container_suffix\', null, \'\');
        $request_param_alias = $modx->getOption(\'request_param_alias\',null,\'q\');
        $request_param_id = $modx->getOption(\'request_param_id\',null,\'id\');
        $url = isset($_GET[$request_param_alias]) ? $_GET[$request_param_alias] : \'\';
        
        $contentType = $modx->getObject(\'modContentType\',array(\'name\'=>\'HTML\'));
        $html_ext = $contentType->getExtension();

        $short_url = $html_ext
            ? substr( $url, 0, ( 0 - strlen( $html_ext ) ) )
            : $url;
        
        $parent_url = strpos( $short_url, \'/\' ) !== false
            ? substr( $short_url, 0, strrpos( $short_url, \'/\' ) ) . $container_suffix
            : \'\';

        $prod_alias = strpos( $short_url, \'/\' ) !== false
            ? substr( $short_url, (strrpos( $short_url, \'/\' )+1) )
            : $short_url;

        $resourceIdentifier = $modx->findResource($parent_url);
        if(!$resourceIdentifier) return \'\';
        
        $resource = $modx->getObject( \'modResource\', array( \'id\' => $resourceIdentifier, \'published\' => true, \'deleted\' => false ) );
        if( !$resource ) return \'\';
        
        //Определяем параметры шаблона
        $templateObj = $resource->getOne(\'Template\');
        $templateProps = !empty($templateObj) ? $templateObj->getProperties() : array();
        if(!empty($templateProps[\'prodPackageName\'])) $prodPackageName = $templateProps[\'prodPackageName\'];
        if(!empty($templateProps[\'prodClassName\'])) $prodClassName = $templateProps[\'prodClassName\'];
        if(!empty($templateProps[\'prodTemplateId\'])) $prodTemplateId = $templateProps[\'prodTemplateId\'];
        
        $modelpath = $modx->getOption(\'core_path\') . \'components/\' . $prodPackageName . \'/model/\';
        $modx->addPackage($prodPackageName, $modelpath);
        
        $product = $modx->getObject( $prodClassName, array( \'resource_id\'=>$resourceIdentifier,\'alias\'=>$prod_alias,\'published\'=>true,\'deleted\'=>false ) );
        
        if($product){
            
            if(!$product->get(\'template\')) $product->set(\'template\',$prodTemplateId);
            $product->set(\'parent\',$resourceIdentifier);
            
            $cacheKey = \'shk_\'.$prodPackageName.\'/\'.$product->get(\'id\');
            
            $cachedResource = $modx->cacheManager->get( $cacheKey, $cacheOptions );
            
            //Вытаскиваем из кэша
            if ( is_array($cachedResource) && array_key_exists(\'resource\', $cachedResource) && is_array($cachedResource[\'resource\']) ) {
                
                $modx->resource = $modx->newObject($cachedResource[\'resourceClass\']);
                
                if ($modx->resource) {
                    
                    $modx->resource->fromArray($cachedResource[\'resource\'], \'\', true, true, true);
                    $modx->resource->_content = $cachedResource[\'resource\'][\'_content\'];
                    $modx->resource->_isForward = isset($cachedResource[\'resource\'][\'_isForward\']) && !empty($cachedResource[\'resource\'][\'_isForward\']);
                    if( !empty($cachedResource[\'resource\'][\'_fieldMeta\']) ){
                        $modx->resource->_fieldMeta = $cachedResource[\'resource\'][\'_fieldMeta\'];
                    }
                    
                    if (isset($cachedResource[\'elementCache\'])) $modx->elementCache = $cachedResource[\'elementCache\'];
                    if (isset($cachedResource[\'sourceCache\'])) $modx->sourceCache = $cachedResource[\'sourceCache\'];
                    if ($modx->resource->get(\'_jscripts\')) $modx->jscripts = $modx->jscripts + $modx->resource->get(\'_jscripts\');
                    if ($modx->resource->get(\'_sjscripts\')) $modx->sjscripts = $modx->sjscripts + $modx->resource->get(\'_sjscripts\');
                    if ($modx->resource->get(\'_loadedjscripts\')) $modx->loadedjscripts = array_merge($modx->loadedjscripts, $modx->resource->get(\'_loadedjscripts\'));
                    $isForward = $modx->resource->_isForward;
                    $modx->resource->setProcessed(true);
                    $fromCache = true;
                    
                    $modx->invokeEvent(\'OnLoadWebPageCache\');
                    
                }
            
            //Если в кэше нет, создаём новый виртуальный ресурс товара
            }else{
                
                $modx->resource = $modx->newObject(\'modResource\');
                
                ####################################################
                //Просчитываем поля по типам ввода связанных TV
                $product_fields = $product->toArray();
                $field_tv = array();
                
                $sql = "
                SELECT `formtabs`
                FROM `".$modx->config[\'table_prefix\']."migx_configs`
                WHERE `name` = \'{$prodPackageName}\'
                ";
                $stmt = $modx->prepare($sql);
                if ($stmt && $stmt->execute()) {
                    $migx_config_formtabs = $stmt->fetchColumn();
                    if($migx_config_formtabs){
                        $migx_config_formtabs_arr = json_decode($migx_config_formtabs,true);
                        foreach($migx_config_formtabs_arr as $formtabs){
                            
                            if(!empty($formtabs[\'fields\'])){
                                $temp_fields = !is_array($formtabs[\'fields\'])? json_decode($formtabs[\'fields\'],true) : $formtabs[\'fields\'];
                            }else{
                                $temp_fields = array();
                            }
                            
                            foreach($temp_fields as $temp_field){
                                if(!empty($temp_field[\'inputTV\'])) $field_tv[$temp_field[\'field\']] = $temp_field[\'inputTV\'];
                            }
                        }
                        
                    }
                }
                $stmt->closeCursor();
                
                foreach($field_tv as $field_name => $tv_name){
                    if(isset($product_fields[$field_name])){
                        
                        $tv_object = $modx->getObject(\'modTemplateVar\',array(\'name\'=>$tv_name));
                        if( is_object($tv_object) ){
                            if($tv_object->get(\'display\')==\'default\') continue;
                            
                            $tv_object->set(\'name\',$field_name);
                            $output_properties = array_merge($tv_object->get(\'output_properties\'),array(\'param_name\'=>$field_name,\'id\'=>$product_fields[\'id\']));
                            $tv_object->set(\'output_properties\',$output_properties);
                            $tv_object->set(\'value\',$product_fields[$field_name]);
                            
                            $value = $product_fields[$field_name];
                            $value = $tv_object->prepareOutput($value);
                            $outputRenderPaths = $tv_object->getRenderDirectories(\'OnTVOutputRenderList\',\'output\');
                            
                            $value = $tv_object->getRender($output_properties,$value,$outputRenderPaths,\'output\',$product_fields[\'id\'],$tv_object->get(\'display\'));
                            
                            $product_fields[$field_name] = $value;
                        }
                    }
                }
                ####################################################
                
                $modx->resource->fromArray(array_merge($resource->toArray(),$product_fields));
                $modx->resource->_fieldMeta = array_merge($resource->_fieldMeta,$product->_fieldMeta);
                
                $modx->resource->set(\'id\',$product->get(\'id\'));
                $modx->resource->set(\'cacheable\',false);
                $modx->resource->set(\'class_key\',$prodClassName);
                $modx->resource->_content = \'\';
                $modx->resource->_output = \'\';
                $modx->resource->_isForward = true;
                
                $modx->elementCache = array();
                $modx->resourceGenerated = true;
                unset($resource);
                
            }
            
            unset($product);
            
            if($debug){
                echo \'<pre>\'.print_r($modx->resource->toArray(),true).\'</pre>\'; exit;
            }
            
            //Просчитываем и выводим HTML-код страницы товара
            $modx->resourceIdentifier = $modx->resource->get(\'id\');
            $modx->resourceMethod = \'id\';
            
            $modx->request->prepareResponse();
            
        }
        
    break;

    case "OnWebPageComplete":
        
        if(!$prodClassName || $prodClassName == \'modResource\') break;
        
        $results= array();
        if ( is_object($modx->resource) && $modx->resource instanceof modResource && $modx->resource->getProcessed() && $modx->resource->get(\'id\') ) {
            
            if( $modx->resource->class_key != $prodClassName ) break;
            
            $cacheKey = \'shk_\'.$prodPackageName.\'/\'.$modx->resource->get(\'id\');
            
            //$cacheProvider = $modx->cacheManager->getCacheProvider($modx->cacheManager->getOption(xPDO::OPT_CACHE_KEY, $cacheOptions));
            //$cachePath = $cacheProvider->getCacheKey( $cacheKey, $cacheOptions );
            
            $cachedResource = $modx->cacheManager->get( $cacheKey, $cacheOptions );
            
            if ( !is_array( $cachedResource ) || empty( $cachedResource ) ) {
                
                $results[\'resourceClass\'] = $modx->resource->_class;
                $results[\'resource\'][\'_processed\'] = $modx->resource->getProcessed();
                $results[\'resource\'] = $modx->resource->toArray(\'\', true);
                $results[\'resource\'][\'_content\'] = $modx->resource->_content;
                $results[\'resource\'][\'_isForward\'] = $modx->resource->_isForward;
                $results[\'resource\'][\'_fieldMeta\'] = $modx->resource->_fieldMeta;
                if ($contentType = $modx->resource->getOne(\'ContentType\')) {
                    $results[\'contentType\'] = $contentType->toArray(\'\', true);
                }
                $results[\'resourceGroups\']= array();
                $context = $modx->resource->_contextKey ? $modx->resource->_contextKey : \'web\';
                $policies = $modx->resource->findPolicy($context);
                if (is_array($policies)) {
                    $results[\'policyCache\'] = $policies;
                }
                if (!empty($modx->elementCache)) {
                    $results[\'elementCache\'] = $modx->elementCache;
                }
                if (!empty($modx->sourceCache)) {
                    $results[\'sourceCache\'] = $modx->sourceCache;
                }
                if (!empty($modx->resource->_sjscripts)) {
                    $results[\'resource\'][\'_sjscripts\'] = $modx->resource->_sjscripts;
                }
                if (!empty($modx->resource->_jscripts)) {
                    $results[\'resource\'][\'_jscripts\'] = $modx->resource->_jscripts;
                }
                if (!empty($modx->resource->_loadedjscripts)) {
                    $results[\'resource\'][\'_loadedjscripts\'] = $modx->resource->_loadedjscripts;
                }
                
                $lifetime = (integer) $modx->cacheManager->getOption(\'cache_resource_expires\', $cacheOptions, $modx->cacheManager->getOption(xPDO::OPT_CACHE_EXPIRES, $cacheOptions, 0));
                
                if (!$modx->cacheManager->set( $cacheKey, $results, $lifetime, $cacheOptions ) ) {
                    $modx->log( modX::LOG_LEVEL_ERROR, "[contextSwitch] Could not cache resource " . $modx->resource->get(\'id\') );
                }
                
            }
            
            unset($cachedResource);
            
        }
        
    break;

}

return \'\';',
      'locked' => 0,
      'properties' => 'a:8:{s:19:"context_param_alias";a:7:{s:4:"name";s:19:"context_param_alias";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"c";s:7:"lexicon";N;s:4:"area";s:0:"";}s:16:"request_param_id";a:7:{s:4:"name";s:16:"request_param_id";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:2:"id";s:7:"lexicon";N;s:4:"area";s:0:"";}s:10:"catalog_id";a:7:{s:4:"name";s:10:"catalog_id";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"0";s:7:"lexicon";N;s:4:"area";s:0:"";}s:11:"context_key";a:7:{s:4:"name";s:11:"context_key";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:7:"catalog";s:7:"lexicon";N;s:4:"area";s:0:"";}s:10:"site_start";a:7:{s:4:"name";s:10:"site_start";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"1";s:7:"lexicon";N;s:4:"area";s:0:"";}s:15:"prodPackageName";a:7:{s:4:"name";s:15:"prodPackageName";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";N;s:4:"area";s:0:"";}s:13:"prodClassName";a:7:{s:4:"name";s:13:"prodClassName";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";N;s:4:"area";s:0:"";}s:14:"prodTemplateId";a:7:{s:4:"name";s:14:"prodTemplateId";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"1";s:7:"lexicon";N;s:4:"area";s:0:"";}}',
      'disabled' => 0,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/*

 plugin contextSwitch
 
 System event: OnHandleRequest, OnPageNotFound, OnWebPageComplete

*/

//ini_set( \'display_errors\', 1 );
//error_reporting(E_ALL);

if($modx->context->get(\'key\') == \'mgr\') return \'\';

$prodPackageName = $modx->getOption(\'prodPackageName\', $scriptProperties, \'\');//shop
$prodClassName = $modx->getOption(\'prodClassName\', $scriptProperties, \'\');//ShopContent
$prodTemplateId = $modx->getOption(\'prodTemplateId\', $scriptProperties, 1);
$debug = $modx->getOption(\'debug\', $scriptProperties, 0);
$cacheOptions = array(
    xPDO::OPT_CACHE_KEY => $modx->getOption(\'cache_resource_key\', $scriptProperties, \'resource\'),
    xPDO::OPT_CACHE_HANDLER => $modx->getOption(\'cache_resource_handler\', $scriptProperties, \'xPDOFileCache\'),
    xPDO::OPT_CACHE_EXPIRES => (integer) $modx->getOption(\'cache_resource_expires\', $scriptProperties, 0),
    xPDO::OPT_CACHE_FORMAT => (integer) $modx->getOption(\'cache_resource_format\', $scriptProperties, xPDOCacheManager::CACHE_PHP),
    xPDO::OPT_CACHE_ATTEMPTS => (integer) $modx->cacheManager->getOption(\'cache_resource_attempts\', null, 1),
    xPDO::OPT_CACHE_ATTEMPT_DELAY => (integer) $modx->cacheManager->getOption(\'cache_resource_attempt_delay\', null, 1000)
);

switch($modx->event->name){
    
    case "OnHandleRequest":
        
        $cntxt_param = $modx->getOption(\'context_param_alias\', null, \'c\');
        $request_param_id = $modx->getOption(\'request_param_id\', null, \'id\');
        $friendly_urls = $modx->getOption(\'friendly_urls\', null, true);
        $container_suffix = $modx->getOption(\'container_suffix\', null, \'\');
        $catalog_id = $modx->getOption(\'catalog_id\',$scriptProperties,0);
        $context_key = $modx->getOption(\'context_key\',$scriptProperties,\'\');
        $site_start = $modx->getOption(\'site_start\', null, 1);
        $request_uri = substr($_SERVER[\'REQUEST_URI\'],0,1)==\'/\' ? substr($_SERVER[\'REQUEST_URI\'],1) : $_SERVER[\'REQUEST_URI\'];
        if( strpos( $request_uri, \'/\' ) !== false ){
            $lang_key = substr( $request_uri, 0, strpos( $request_uri, \'/\' ) );
        }else{
            $lang_key = $request_uri;
        }
        
        if( !$context_key ) return \'\';
        
        if( $modx->config[\'friendly_urls\'] ){
            
            if( $request_uri ){
                
                $contentType = $modx->getObject(\'modContentType\',array(\'name\'=>\'HTML\'));
                $html_ext = $contentType->getExtension();
                
                $base_dir_alias = current( explode( \'/\', $request_uri ) );
                if( strlen( $container_suffix ) > 1 && strpos( $base_dir_alias, $container_suffix ) === false ){
                    $base_dir_alias .= $container_suffix;
                }
                if( !$container_suffix && $html_ext ){
                    $base_dir_alias .= $html_ext;
                }
                
                $context_child_ids = $modx->getChildIds( 0, 1, array( \'context\' => $context_key ) );
                
                //Проверяем нужно ли переключать контекст
                $switch_action = false;
                foreach( $context_child_ids as $id ){
                    $temp_url = basename( $modx->makeURL( $id,$context_key, \'\', \'abs\' ) );
                    if( $temp_url == $base_dir_alias ){
                        $switch_action = true;
                        break;
                    }
                }
                
                if( $switch_action ){
                    $modx->reloadContext( $context_key );
                    $modx->switchContext( $context_key );
                    $modx->config[\'site_start\'] = $site_start;
                    $modx->setPlaceholder( \'context_key\', $context_key );
                }
                
            }
            
        }else{
            
            $requestId = !empty($_REQUEST[$request_param_id]) && is_numeric($_REQUEST[$request_param_id]) ? $_REQUEST[$request_param_id] : 0;
            if(!$requestId) return \'\';
            $resource = $modx->getObject( \'modResource\', $requestId );
            if( $resource && $resource->get(\'context_key\') == $context_key ){
                $modx->reloadContext( $context_key );
                $modx->switchContext( $context_key );
                $modx->config[\'site_start\'] = $site_start;
                $modx->setPlaceholder( \'context_key\', $context_key );
            }
            
        }
    
    break;
    case "OnPageNotFound":
        
        if(!$prodClassName || $prodClassName==\'modResource\') break;
        
        $container_suffix = $modx->getOption(\'container_suffix\', null, \'\');
        $request_param_alias = $modx->getOption(\'request_param_alias\',null,\'q\');
        $request_param_id = $modx->getOption(\'request_param_id\',null,\'id\');
        $url = isset($_GET[$request_param_alias]) ? $_GET[$request_param_alias] : \'\';
        
        $contentType = $modx->getObject(\'modContentType\',array(\'name\'=>\'HTML\'));
        $html_ext = $contentType->getExtension();

        $short_url = $html_ext
            ? substr( $url, 0, ( 0 - strlen( $html_ext ) ) )
            : $url;
        
        $parent_url = strpos( $short_url, \'/\' ) !== false
            ? substr( $short_url, 0, strrpos( $short_url, \'/\' ) ) . $container_suffix
            : \'\';

        $prod_alias = strpos( $short_url, \'/\' ) !== false
            ? substr( $short_url, (strrpos( $short_url, \'/\' )+1) )
            : $short_url;

        $resourceIdentifier = $modx->findResource($parent_url);
        if(!$resourceIdentifier) return \'\';
        
        $resource = $modx->getObject( \'modResource\', array( \'id\' => $resourceIdentifier, \'published\' => true, \'deleted\' => false ) );
        if( !$resource ) return \'\';
        
        //Определяем параметры шаблона
        $templateObj = $resource->getOne(\'Template\');
        $templateProps = !empty($templateObj) ? $templateObj->getProperties() : array();
        if(!empty($templateProps[\'prodPackageName\'])) $prodPackageName = $templateProps[\'prodPackageName\'];
        if(!empty($templateProps[\'prodClassName\'])) $prodClassName = $templateProps[\'prodClassName\'];
        if(!empty($templateProps[\'prodTemplateId\'])) $prodTemplateId = $templateProps[\'prodTemplateId\'];
        
        $modelpath = $modx->getOption(\'core_path\') . \'components/\' . $prodPackageName . \'/model/\';
        $modx->addPackage($prodPackageName, $modelpath);
        
        $product = $modx->getObject( $prodClassName, array( \'resource_id\'=>$resourceIdentifier,\'alias\'=>$prod_alias,\'published\'=>true,\'deleted\'=>false ) );
        
        if($product){
            
            if(!$product->get(\'template\')) $product->set(\'template\',$prodTemplateId);
            $product->set(\'parent\',$resourceIdentifier);
            
            $cacheKey = \'shk_\'.$prodPackageName.\'/\'.$product->get(\'id\');
            
            $cachedResource = $modx->cacheManager->get( $cacheKey, $cacheOptions );
            
            //Вытаскиваем из кэша
            if ( is_array($cachedResource) && array_key_exists(\'resource\', $cachedResource) && is_array($cachedResource[\'resource\']) ) {
                
                $modx->resource = $modx->newObject($cachedResource[\'resourceClass\']);
                
                if ($modx->resource) {
                    
                    $modx->resource->fromArray($cachedResource[\'resource\'], \'\', true, true, true);
                    $modx->resource->_content = $cachedResource[\'resource\'][\'_content\'];
                    $modx->resource->_isForward = isset($cachedResource[\'resource\'][\'_isForward\']) && !empty($cachedResource[\'resource\'][\'_isForward\']);
                    if( !empty($cachedResource[\'resource\'][\'_fieldMeta\']) ){
                        $modx->resource->_fieldMeta = $cachedResource[\'resource\'][\'_fieldMeta\'];
                    }
                    
                    if (isset($cachedResource[\'elementCache\'])) $modx->elementCache = $cachedResource[\'elementCache\'];
                    if (isset($cachedResource[\'sourceCache\'])) $modx->sourceCache = $cachedResource[\'sourceCache\'];
                    if ($modx->resource->get(\'_jscripts\')) $modx->jscripts = $modx->jscripts + $modx->resource->get(\'_jscripts\');
                    if ($modx->resource->get(\'_sjscripts\')) $modx->sjscripts = $modx->sjscripts + $modx->resource->get(\'_sjscripts\');
                    if ($modx->resource->get(\'_loadedjscripts\')) $modx->loadedjscripts = array_merge($modx->loadedjscripts, $modx->resource->get(\'_loadedjscripts\'));
                    $isForward = $modx->resource->_isForward;
                    $modx->resource->setProcessed(true);
                    $fromCache = true;
                    
                    $modx->invokeEvent(\'OnLoadWebPageCache\');
                    
                }
            
            //Если в кэше нет, создаём новый виртуальный ресурс товара
            }else{
                
                $modx->resource = $modx->newObject(\'modResource\');
                
                ####################################################
                //Просчитываем поля по типам ввода связанных TV
                $product_fields = $product->toArray();
                $field_tv = array();
                
                $sql = "
                SELECT `formtabs`
                FROM `".$modx->config[\'table_prefix\']."migx_configs`
                WHERE `name` = \'{$prodPackageName}\'
                ";
                $stmt = $modx->prepare($sql);
                if ($stmt && $stmt->execute()) {
                    $migx_config_formtabs = $stmt->fetchColumn();
                    if($migx_config_formtabs){
                        $migx_config_formtabs_arr = json_decode($migx_config_formtabs,true);
                        foreach($migx_config_formtabs_arr as $formtabs){
                            
                            if(!empty($formtabs[\'fields\'])){
                                $temp_fields = !is_array($formtabs[\'fields\'])? json_decode($formtabs[\'fields\'],true) : $formtabs[\'fields\'];
                            }else{
                                $temp_fields = array();
                            }
                            
                            foreach($temp_fields as $temp_field){
                                if(!empty($temp_field[\'inputTV\'])) $field_tv[$temp_field[\'field\']] = $temp_field[\'inputTV\'];
                            }
                        }
                        
                    }
                }
                $stmt->closeCursor();
                
                foreach($field_tv as $field_name => $tv_name){
                    if(isset($product_fields[$field_name])){
                        
                        $tv_object = $modx->getObject(\'modTemplateVar\',array(\'name\'=>$tv_name));
                        if( is_object($tv_object) ){
                            if($tv_object->get(\'display\')==\'default\') continue;
                            
                            $tv_object->set(\'name\',$field_name);
                            $output_properties = array_merge($tv_object->get(\'output_properties\'),array(\'param_name\'=>$field_name,\'id\'=>$product_fields[\'id\']));
                            $tv_object->set(\'output_properties\',$output_properties);
                            $tv_object->set(\'value\',$product_fields[$field_name]);
                            
                            $value = $product_fields[$field_name];
                            $value = $tv_object->prepareOutput($value);
                            $outputRenderPaths = $tv_object->getRenderDirectories(\'OnTVOutputRenderList\',\'output\');
                            
                            $value = $tv_object->getRender($output_properties,$value,$outputRenderPaths,\'output\',$product_fields[\'id\'],$tv_object->get(\'display\'));
                            
                            $product_fields[$field_name] = $value;
                        }
                    }
                }
                ####################################################
                
                $modx->resource->fromArray(array_merge($resource->toArray(),$product_fields));
                $modx->resource->_fieldMeta = array_merge($resource->_fieldMeta,$product->_fieldMeta);
                
                $modx->resource->set(\'id\',$product->get(\'id\'));
                $modx->resource->set(\'cacheable\',false);
                $modx->resource->set(\'class_key\',$prodClassName);
                $modx->resource->_content = \'\';
                $modx->resource->_output = \'\';
                $modx->resource->_isForward = true;
                
                $modx->elementCache = array();
                $modx->resourceGenerated = true;
                unset($resource);
                
            }
            
            unset($product);
            
            if($debug){
                echo \'<pre>\'.print_r($modx->resource->toArray(),true).\'</pre>\'; exit;
            }
            
            //Просчитываем и выводим HTML-код страницы товара
            $modx->resourceIdentifier = $modx->resource->get(\'id\');
            $modx->resourceMethod = \'id\';
            
            $modx->request->prepareResponse();
            
        }
        
    break;

    case "OnWebPageComplete":
        
        if(!$prodClassName || $prodClassName == \'modResource\') break;
        
        $results= array();
        if ( is_object($modx->resource) && $modx->resource instanceof modResource && $modx->resource->getProcessed() && $modx->resource->get(\'id\') ) {
            
            if( $modx->resource->class_key != $prodClassName ) break;
            
            $cacheKey = \'shk_\'.$prodPackageName.\'/\'.$modx->resource->get(\'id\');
            
            //$cacheProvider = $modx->cacheManager->getCacheProvider($modx->cacheManager->getOption(xPDO::OPT_CACHE_KEY, $cacheOptions));
            //$cachePath = $cacheProvider->getCacheKey( $cacheKey, $cacheOptions );
            
            $cachedResource = $modx->cacheManager->get( $cacheKey, $cacheOptions );
            
            if ( !is_array( $cachedResource ) || empty( $cachedResource ) ) {
                
                $results[\'resourceClass\'] = $modx->resource->_class;
                $results[\'resource\'][\'_processed\'] = $modx->resource->getProcessed();
                $results[\'resource\'] = $modx->resource->toArray(\'\', true);
                $results[\'resource\'][\'_content\'] = $modx->resource->_content;
                $results[\'resource\'][\'_isForward\'] = $modx->resource->_isForward;
                $results[\'resource\'][\'_fieldMeta\'] = $modx->resource->_fieldMeta;
                if ($contentType = $modx->resource->getOne(\'ContentType\')) {
                    $results[\'contentType\'] = $contentType->toArray(\'\', true);
                }
                $results[\'resourceGroups\']= array();
                $context = $modx->resource->_contextKey ? $modx->resource->_contextKey : \'web\';
                $policies = $modx->resource->findPolicy($context);
                if (is_array($policies)) {
                    $results[\'policyCache\'] = $policies;
                }
                if (!empty($modx->elementCache)) {
                    $results[\'elementCache\'] = $modx->elementCache;
                }
                if (!empty($modx->sourceCache)) {
                    $results[\'sourceCache\'] = $modx->sourceCache;
                }
                if (!empty($modx->resource->_sjscripts)) {
                    $results[\'resource\'][\'_sjscripts\'] = $modx->resource->_sjscripts;
                }
                if (!empty($modx->resource->_jscripts)) {
                    $results[\'resource\'][\'_jscripts\'] = $modx->resource->_jscripts;
                }
                if (!empty($modx->resource->_loadedjscripts)) {
                    $results[\'resource\'][\'_loadedjscripts\'] = $modx->resource->_loadedjscripts;
                }
                
                $lifetime = (integer) $modx->cacheManager->getOption(\'cache_resource_expires\', $cacheOptions, $modx->cacheManager->getOption(xPDO::OPT_CACHE_EXPIRES, $cacheOptions, 0));
                
                if (!$modx->cacheManager->set( $cacheKey, $results, $lifetime, $cacheOptions ) ) {
                    $modx->log( modX::LOG_LEVEL_ERROR, "[contextSwitch] Could not cache resource " . $modx->resource->get(\'id\') );
                }
                
            }
            
            unset($cachedResource);
            
        }
        
    break;

}

return \'\';',
    ),
  ),
  '706aecf0de600260d40ff17873a897b6' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 6,
      'event' => 'OnHandleRequest',
    ),
    'object' => 
    array (
      'pluginid' => 6,
      'event' => 'OnHandleRequest',
      'priority' => 1,
      'propertyset' => 0,
    ),
  ),
  'f70ac30a52f821a811fb25e7d291c690' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 6,
      'event' => 'OnPageNotFound',
    ),
    'object' => 
    array (
      'pluginid' => 6,
      'event' => 'OnPageNotFound',
      'priority' => 2,
      'propertyset' => 0,
    ),
  ),
  'ac99ebfb8a96c86140498da1c87045ac' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 6,
      'event' => 'OnWebPageComplete',
    ),
    'object' => 
    array (
      'pluginid' => 6,
      'event' => 'OnWebPageComplete',
      'priority' => 3,
      'propertyset' => 0,
    ),
  ),
  '220652a6369dd55e30e32c78bfd6c40f' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk_updateInventory',
    ),
    'object' => 
    array (
      'id' => 7,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shk_updateInventory',
      'description' => 'Update inventory data.',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'plugincode' => '/*
 * shk_updateInventory
 * 
 * Плагин обновляет количество товара на складе при переводе статуса заказа в "Отправлен" (или др.)
 * 
 * OnSHKChangeStatus
 */

$eventName = $modx->event->name;

$inventory_fieldname = $modx->getOption( \'inventory_fieldname\', $scriptProperties, \'inventory\' );
$plugin_status = $modx->getOption( \'plugin_status\', $scriptProperties, \'2\' );
$context = $modx->getOption( \'context\', $scriptProperties, \'\' );
$order_ids = $modx->getOption( \'order_ids\', $scriptProperties, array() );
if( !is_array( $order_ids ) ){
    $order_ids = $order_ids && is_numeric( $order_ids ) ? array( $order_ids ) : array();
}
$status = $modx->getOption( \'status\', $scriptProperties, \'\' );

if( empty( $order_ids ) || empty( $status ) || $status != $plugin_status ) return \'\';

$modelpath = $modx->getOption(\'core_path\') . \'components/shopkeeper3/model/\';
$modx->addPackage( \'shopkeeper3\', $modelpath );

foreach( $order_ids as $order_id ){
    
    $query = $modx->newQuery( \'shk_purchases\' );
    $query->where( array( \'order_id\' => $order_id ) );
    $purchases = $modx->getIterator( \'shk_purchases\', $query );
    
    if( $purchases ){
        
        foreach( $purchases as $purchase ){
            
            if( $purchase->package_name && $purchase->package_name != \'modResource\' && !in_array( $purchase->package_name, array_keys($modx->packages) ) ){
                $modelpath = $modx->getOption(\'core_path\') . \'components/\' . $purchase->package_name . \'/model/\';
                $modx->addPackage( $purchase->package_name, $modelpath );
            }
            
            $product = $modx->getObject( $purchase->class_name, $purchase->p_id );
            if( $product ){
                
                $p_data = $product->toArray();
                
                //Если это поле основной таблицы
                if( isset( $p_data[ $inventory_fieldname ] ) ){
                    
                    $current_inventory = $p_data[ $inventory_fieldname ];
                    $current_inventory = $current_inventory ? floatval( $current_inventory ) : 0;
                    if( !$current_inventory ) continue;
                    
                    $new_inventory = $current_inventory - $purchase->count;
                    if( $new_inventory < 0 ) $new_inventory = 0;
                    
                    $product->set( $inventory_fieldname, $new_inventory );
                    $product->save();
                    
                }
                //Если значение хранится в TV параметре
                else{
                    
                    $table_name = \'\';
                    if ( $className = $modx->loadClass( $purchase->class_name ) ) {
                        $table_name = isset( $modx->map[$className][\'table\'] ) ? $modx->map[$className][\'table\'] : \'\';
                    }
                    if( $table_name != \'site_content\' ) continue;
                    
                    $context = $p_data[\'context_key\'];
                    
                    $tv = $modx->getObject( \'modTemplateVar\', array( \'name\' => $inventory_fieldname ));
                    if( !$tv ) continue;
                    
                    $current_inventory = $tv->getValue( $p_data[\'id\'] );
                    $current_inventory = $current_inventory ? floatval( $current_inventory ) : 0;
                    if( !$current_inventory ) continue;
                    
                    $new_inventory = $current_inventory - $purchase->count;
                    if( $new_inventory < 0 ) $new_inventory = 0;
                    
                    //$tv->setValue( $p_data[\'id\'], $new_inventory );
                    
                    $templateVarResource = $modx->getObject(\'modTemplateVarResource\',array(
                        \'tmplvarid\' => $tv->get(\'id\'),
                        \'contentid\' => $p_data[\'id\'],
                    ),true);
                    
                    if( $templateVarResource ){
                        $templateVarResource->set( \'value\', $new_inventory );
                        $templateVarResource->save();
                    }
                    
                }
                
            }
            
        }
        
    }
    
}


//Очистка кэша сайта
if( $context ){
    $modx->cacheManager->refresh(array(
        \'resource\' => array( \'contexts\' => array( $context ) ),
    ));
}

return \'\';',
      'locked' => 0,
      'properties' => 'a:3:{s:13:"plugin_status";a:7:{s:4:"name";s:13:"plugin_status";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"2";s:7:"lexicon";N;s:4:"area";s:0:"";}s:19:"inventory_fieldname";a:7:{s:4:"name";s:19:"inventory_fieldname";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:9:"inventory";s:7:"lexicon";N;s:4:"area";s:0:"";}s:7:"context";a:7:{s:4:"name";s:7:"context";s:4:"desc";s:0:"";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:3:"web";s:7:"lexicon";N;s:4:"area";s:0:"";}}',
      'disabled' => 1,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/*
 * shk_updateInventory
 * 
 * Плагин обновляет количество товара на складе при переводе статуса заказа в "Отправлен" (или др.)
 * 
 * OnSHKChangeStatus
 */

$eventName = $modx->event->name;

$inventory_fieldname = $modx->getOption( \'inventory_fieldname\', $scriptProperties, \'inventory\' );
$plugin_status = $modx->getOption( \'plugin_status\', $scriptProperties, \'2\' );
$context = $modx->getOption( \'context\', $scriptProperties, \'\' );
$order_ids = $modx->getOption( \'order_ids\', $scriptProperties, array() );
if( !is_array( $order_ids ) ){
    $order_ids = $order_ids && is_numeric( $order_ids ) ? array( $order_ids ) : array();
}
$status = $modx->getOption( \'status\', $scriptProperties, \'\' );

if( empty( $order_ids ) || empty( $status ) || $status != $plugin_status ) return \'\';

$modelpath = $modx->getOption(\'core_path\') . \'components/shopkeeper3/model/\';
$modx->addPackage( \'shopkeeper3\', $modelpath );

foreach( $order_ids as $order_id ){
    
    $query = $modx->newQuery( \'shk_purchases\' );
    $query->where( array( \'order_id\' => $order_id ) );
    $purchases = $modx->getIterator( \'shk_purchases\', $query );
    
    if( $purchases ){
        
        foreach( $purchases as $purchase ){
            
            if( $purchase->package_name && $purchase->package_name != \'modResource\' && !in_array( $purchase->package_name, array_keys($modx->packages) ) ){
                $modelpath = $modx->getOption(\'core_path\') . \'components/\' . $purchase->package_name . \'/model/\';
                $modx->addPackage( $purchase->package_name, $modelpath );
            }
            
            $product = $modx->getObject( $purchase->class_name, $purchase->p_id );
            if( $product ){
                
                $p_data = $product->toArray();
                
                //Если это поле основной таблицы
                if( isset( $p_data[ $inventory_fieldname ] ) ){
                    
                    $current_inventory = $p_data[ $inventory_fieldname ];
                    $current_inventory = $current_inventory ? floatval( $current_inventory ) : 0;
                    if( !$current_inventory ) continue;
                    
                    $new_inventory = $current_inventory - $purchase->count;
                    if( $new_inventory < 0 ) $new_inventory = 0;
                    
                    $product->set( $inventory_fieldname, $new_inventory );
                    $product->save();
                    
                }
                //Если значение хранится в TV параметре
                else{
                    
                    $table_name = \'\';
                    if ( $className = $modx->loadClass( $purchase->class_name ) ) {
                        $table_name = isset( $modx->map[$className][\'table\'] ) ? $modx->map[$className][\'table\'] : \'\';
                    }
                    if( $table_name != \'site_content\' ) continue;
                    
                    $context = $p_data[\'context_key\'];
                    
                    $tv = $modx->getObject( \'modTemplateVar\', array( \'name\' => $inventory_fieldname ));
                    if( !$tv ) continue;
                    
                    $current_inventory = $tv->getValue( $p_data[\'id\'] );
                    $current_inventory = $current_inventory ? floatval( $current_inventory ) : 0;
                    if( !$current_inventory ) continue;
                    
                    $new_inventory = $current_inventory - $purchase->count;
                    if( $new_inventory < 0 ) $new_inventory = 0;
                    
                    //$tv->setValue( $p_data[\'id\'], $new_inventory );
                    
                    $templateVarResource = $modx->getObject(\'modTemplateVarResource\',array(
                        \'tmplvarid\' => $tv->get(\'id\'),
                        \'contentid\' => $p_data[\'id\'],
                    ),true);
                    
                    if( $templateVarResource ){
                        $templateVarResource->set( \'value\', $new_inventory );
                        $templateVarResource->save();
                    }
                    
                }
                
            }
            
        }
        
    }
    
}


//Очистка кэша сайта
if( $context ){
    $modx->cacheManager->refresh(array(
        \'resource\' => array( \'contexts\' => array( $context ) ),
    ));
}

return \'\';',
    ),
  ),
  '629657d33e4f8c064528f99bff1dbdf3' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 7,
      'event' => 'OnSHKChangeStatus',
    ),
    'object' => 
    array (
      'pluginid' => 7,
      'event' => 'OnSHKChangeStatus',
      'priority' => 1,
      'propertyset' => 0,
    ),
  ),
  '6a28b926947d847ec929d121d699c7fd' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk_tv_input_output',
    ),
    'object' => 
    array (
      'id' => 8,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shk_tv_input_output',
      'description' => 'Print Shopkeeper`s input and output types for TV.',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'plugincode' => '$corePath = MODX_CORE_PATH.\'components/shopkeeper3/\';

switch ($modx->event->name) {
    //tv input
    case \'OnTVInputRenderList\':
        if($modx->context->get(\'key\') != \'mgr\') return;
        $modx->regClientStartupScript($modx->getOption(\'assets_url\').\'components/shopkeeper3/mgr/js/shk_mgr.js\');
        $modx->regClientStartupScript($modx->getOption(\'assets_url\').\'components/shopkeeper3/mgr/js/widgets/shk.grid.js\');
        $modx->regClientCSS($modx->getOption(\'assets_url\').\'components/shopkeeper3/mgr/css/mgr.css\');
        $modx->event->output($corePath.\'elements/tv/input/\');
    break;
    case \'OnTVInputPropertiesList\':
        if($modx->context->get(\'key\') != \'mgr\') return;
        $modx->event->output($corePath.\'elements/tv/inputproperties/\');
    break;
    //tv output
    case \'OnTVOutputRenderList\':
        $modx->event->output($corePath.\'elements/tv/output/\');
    break;
    case \'OnTVOutputRenderPropertiesList\':
        $modx->event->output($corePath.\'elements/tv/outputproperties/\');
    break;
}

return;',
      'locked' => 0,
      'properties' => NULL,
      'disabled' => 0,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '$corePath = MODX_CORE_PATH.\'components/shopkeeper3/\';

switch ($modx->event->name) {
    //tv input
    case \'OnTVInputRenderList\':
        if($modx->context->get(\'key\') != \'mgr\') return;
        $modx->regClientStartupScript($modx->getOption(\'assets_url\').\'components/shopkeeper3/mgr/js/shk_mgr.js\');
        $modx->regClientStartupScript($modx->getOption(\'assets_url\').\'components/shopkeeper3/mgr/js/widgets/shk.grid.js\');
        $modx->regClientCSS($modx->getOption(\'assets_url\').\'components/shopkeeper3/mgr/css/mgr.css\');
        $modx->event->output($corePath.\'elements/tv/input/\');
    break;
    case \'OnTVInputPropertiesList\':
        if($modx->context->get(\'key\') != \'mgr\') return;
        $modx->event->output($corePath.\'elements/tv/inputproperties/\');
    break;
    //tv output
    case \'OnTVOutputRenderList\':
        $modx->event->output($corePath.\'elements/tv/output/\');
    break;
    case \'OnTVOutputRenderPropertiesList\':
        $modx->event->output($corePath.\'elements/tv/outputproperties/\');
    break;
}

return;',
    ),
  ),
  '5d2d0f5c64809fd6dcbfb7f0d4e7c160' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 8,
      'event' => 'OnTVInputRenderList',
    ),
    'object' => 
    array (
      'pluginid' => 8,
      'event' => 'OnTVInputRenderList',
      'priority' => 1,
      'propertyset' => 0,
    ),
  ),
  '268c27e64ccc304665d8df51d31ead70' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 8,
      'event' => 'OnTVInputPropertiesList',
    ),
    'object' => 
    array (
      'pluginid' => 8,
      'event' => 'OnTVInputPropertiesList',
      'priority' => 2,
      'propertyset' => 0,
    ),
  ),
  'f52f541a137119ab07c6923d13386c39' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 8,
      'event' => 'OnTVOutputRenderList',
    ),
    'object' => 
    array (
      'pluginid' => 8,
      'event' => 'OnTVOutputRenderList',
      'priority' => 3,
      'propertyset' => 0,
    ),
  ),
  'ca3da1beb9fd138b66d8845dbb0c90c0' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 8,
      'event' => 'OnTVOutputRenderPropertiesList',
    ),
    'object' => 
    array (
      'pluginid' => 8,
      'event' => 'OnTVOutputRenderPropertiesList',
      'priority' => 4,
      'propertyset' => 0,
    ),
  ),
  'cc624a8e27d76a7694cc85867845727d' => 
  array (
    'criteria' => 
    array (
      'name' => 'shk_multicurrency',
    ),
    'object' => 
    array (
      'id' => 9,
      'source' => 1,
      'property_preprocess' => 0,
      'name' => 'shk_multicurrency',
      'description' => 'Multicurrency in store.',
      'editor_type' => 0,
      'category' => 3,
      'cache_type' => 0,
      'plugincode' => '/*
 plugin shk_multicurrency
 System event: OnLoadWebDocument, OnSHKgetProductPrice, OnSHKgetProductAdditParamPrice, OnSHKgetDeliveryPrice

<div>
    Валюта:
    <select id="site_currency" name="curency">
        <option value="1">руб.</option>
        <option value="2">грн.</option>
        <option value="3">USD</option>
        <option value="4">euro</option>
    </select>
</div>

*/

$scriptProperties = array_merge(
    array(
        \'currency_default\' => $modx->getOption( \'shk3.currency_default\', null, 1 ),
        \'currency_selected\' => $modx->getOption( \'shk3.currency_selected\', null, 0 )
    ),
    $scriptProperties
);

$shk_currency = !empty($_COOKIE[\'shk_currency\']) && is_numeric($_COOKIE[\'shk_currency\'])
    ? abs(intval($_COOKIE[\'shk_currency\']))
    : $scriptProperties[\'currency_default\'];
//Если нужен всегда преевод в одну валюту
if( !empty( $scriptProperties[\'currency_selected\'] ) && $shk_currency != $scriptProperties[\'currency_selected\'] ){
    setcookie( \'shk_currency\', intval($scriptProperties[\'currency_selected\']), time()+3600*24, "/" );
    $shk_currency = intval($scriptProperties[\'currency_selected\']);
}
$currency_id = isset($_GET[\'scurr\']) && is_numeric($_GET[\'scurr\']) ? intval($_GET[\'scurr\']) : $shk_currency;

if(!function_exists(\'shk_currency_calc\')){
    function shk_currency_calc($properties, $base_price, $currency_id, $rate_ratio = 0){
        
        $inverse = isset($properties[\'inverse\']) ? $properties[\'inverse\'] : false;//обратный перевод цены
        
        if( !$rate_ratio ){
            
            if( isset( $_SESSION[\'shk_curr_rate\'] ) && is_numeric( $_SESSION[\'shk_curr_rate\'] ) && !$inverse ){
                
                $rate_ratio = $_SESSION[\'shk_curr_rate\'];
                
            }else{
                
                if( !isset( $properties[\'currency_rate\'] ) ){
                    require_once MODX_CORE_PATH . "components/shopkeeper3/model/shopkeeper.class.php";
                    $config = Shopkeeper::getConfig( array(\'currency_rate\') );
                    $properties[\'currency_rate\'] = $config[\'currency_rate\'];
                }
                
                $rate_ratio = 1;
                
                if( $properties[\'currency_default\'] != $currency_id ){
                    
                    $rate_default = 1;
                    $rate = 1;
                    //Определяем курс по умолчанию и новый курс
                    foreach( $properties[\'currency_rate\'] as $rt ){
                        if( $rt[\'id\'] == $properties[\'currency_default\'] ){
                            $rate_default = Shopkeeper::cleanNumber( $rt[\'value\'], \'float\' );
                        }
                        else if( $rt[\'id\'] == $currency_id ){
                            $rate = Shopkeeper::cleanNumber( $rt[\'value\'], \'float\' );
                        }
                    }
                    
                    if( !$inverse ){
                        $rate_ratio = $rate_default / $rate;
                        $_SESSION[\'shk_curr_rate\'] = $rate_ratio;
                    }else{
                        $rate_ratio = $rate / $rate_default;
                    }
                    
                }
                
            }
            
        }
        
        //Считаем цену по курсу
        if( $rate_ratio ){
            
            $price = $base_price * $rate_ratio;
            $price = round( $price, ( ceil( $price ) == $price ? 0 : 2 ) );
            return $price;
        
        }else{
            return $base_price;
        }
        
    }
}

switch($modx->event->name){
    
    case \'OnLoadWebDocument\':
        
        if( !empty( $modx->placeholders[\'shk_currency\'] ) ) return \'\';
        
        if(empty($scriptProperties[\'noScript\'])){
            
            $script_str = \'
            <script type="text/javascript">
                var shk_cindex = document.cookie.indexOf("shk_currency=") > -1 ? document.cookie.indexOf("shk_currency=") + new String("shk_currency=").length : -1;
                var shk_currency = shk_cindex > -1 ? document.cookie.substring(shk_cindex,shk_cindex+1) : 1;
                jQuery("#site_currency")
                .val(shk_currency)
                .on("change",function(){
                    var loc_href = window.location.pathname+document.location.search;
                    window.location.href = loc_href+(loc_href.indexOf("?") > -1 ? "&" : "?") + "scurr=" + this.value;
                });
            </script>
            \';
            $modx->regClientScript( $script_str, true );
        }
        
        if( isset( $_GET[\'scurr\'] ) ){
            
            if( $currency_id != $shk_currency ){
                
                require_once MODX_CORE_PATH . "components/shopkeeper3/model/shopkeeper.class.php";
                
                $config = Shopkeeper::getConfig( array( \'currency_rate\', \'delivery\' ) );
                $scriptProperties[\'currency_rate\'] = $config[\'currency_rate\'];
                $conf_delivery = $config[\'delivery\'];
                
            }
            
            $_SESSION[\'shk_curr_rate\'] = null;
            unset($_SESSION[\'shk_curr_rate\']);
            
            //Доставка
            if( !empty( $conf_delivery ) ){
                
                $delivery_label = !empty( $_SESSION[\'shk_delivery\'][\'label\'] ) ? $_SESSION[\'shk_delivery\'][\'label\'] : \'\';
                $delivery_price = !empty( $_SESSION[\'shk_delivery\'][\'price\'] ) ? $_SESSION[\'shk_delivery\'][\'price\'] : 0;
                $_SESSION[\'shk_delivery\'] = array();
                
                foreach( $conf_delivery as $opt ){
                    
                    if( $opt[\'label\'] == $delivery_label ){
                        
                        $_SESSION[\'shk_delivery\'] = array(
                            \'label\' => $opt[\'label\'],
                            \'price\' => $delivery_price > 0 ? Shopkeeper::cleanNumber( $opt[\'price\'], \'float\' ) : 0,
                            \'old_price\' => Shopkeeper::cleanNumber( $opt[\'price\'], \'float\' ),
                            \'free_start\' => Shopkeeper::cleanNumber( $opt[\'free_start\'], \'float\' ),
                            \'old_free_start\' => Shopkeeper::cleanNumber( $opt[\'free_start\'], \'float\' )
                        );
                        
                        break;
                    }
                    
                }
                
                if( !empty( $_SESSION[\'shk_delivery\'][\'price\'] ) ){
                    $_SESSION[\'shk_delivery\'][\'price\'] = shk_currency_calc( $scriptProperties, $_SESSION[\'shk_delivery\'][\'price\'], $currency_id );
                }
                if( !empty( $_SESSION[\'shk_delivery\'][\'old_price\'] ) ){
                    $_SESSION[\'shk_delivery\'][\'old_price\'] = shk_currency_calc( $scriptProperties, $_SESSION[\'shk_delivery\'][\'old_price\'], $currency_id );
                }
                if( !empty( $_SESSION[\'shk_delivery\'][\'free_start\'] ) ){
                    $_SESSION[\'shk_delivery\'][\'free_start\'] = shk_currency_calc( $scriptProperties, $_SESSION[\'shk_delivery\'][\'free_start\'], $currency_id );
                    $_SESSION[\'shk_delivery\'][\'old_free_start\'] = $_SESSION[\'shk_delivery\'][\'free_start\'];
                }
                
            }
            
            $purchases = !empty( $_SESSION[\'shk_order\'] ) ? $_SESSION[\'shk_order\'] : array();
            
            if( !empty( $scriptProperties[\'currency_rate\'] ) ){
                
                //Изменяем цены товаров в корзине
                if( !empty( $purchases ) ){
                    
                    foreach( $purchases as $key => &$purchase ){
                        
                        if( isset( $purchase[\'old_price\'] ) ){
                            $base_price = $purchase[\'old_price\'];
                        }
                        else if( !isset( $purchase[\'old_price\'] ) ) {
                            $purchase[\'old_price\'] = $purchase[\'price\'];
                            $base_price = $purchase[\'price\'];
                        }
                        
                        $purchase[\'price\'] = shk_currency_calc( $scriptProperties, $base_price, $currency_id );
                        
                        //Доп. параметры
                        if( !empty( $purchase[\'options\'] ) ){
                            foreach( $purchase[\'options\'] as &$addit_param ){
                                
                                if( !isset( $addit_param[3] ) ) $addit_param[3] = $addit_param[1];
                                $addit_param[1] = shk_currency_calc( $scriptProperties, $addit_param[3], $currency_id );
                                
                            }
                        }
                        
                    }
                    
                    $_SESSION[\'shk_order\'] = $purchases;
                    
                }else{
                    
                    //Если нет товаров, просто переключаем валюту
                    shk_currency_calc( $scriptProperties, 0, $currency_id );
                    
                }
                
                $shk_currency = $currency_id;
                setcookie( \'shk_currency\', $shk_currency, time()+3600*24, "/" );
                
                //Сохраняем название валюты
                $currency_name = \'\';
                foreach( $scriptProperties[\'currency_rate\'] as $rt ){
                    if( $rt[\'id\'] == $currency_id ){
                        $currency_name = $rt[\'label\'];
                        break;
                    }
                }
                $_SESSION[\'shk_currency_name\'] = $currency_name;
                
            }
            
            $back_url = !empty($_SERVER[\'HTTP_REFERER\']) ? $_SERVER[\'HTTP_REFERER\'] : $modx->makeURL($modx->resource->get(\'parent\'),\'\',\'\',\'abs\');
            if( $modx->config[\'friendly_urls\'] ){
                if( strpos($back_url,\'?\') !== false ) $back_url = substr( $back_url, 0, strpos($back_url,\'?\') );
            }
            
            $modx->sendRedirect( $back_url, 0 );
            
        }
        
        $currency_name = !empty($_SESSION[\'shk_currency_name\']) ? $_SESSION[\'shk_currency_name\'] : \'\';
        if( !$currency_name ){
            $currency_name = $modx->getOption(\'shk3.currency\',null,\'\');
        }
        $modx->setPlaceholder( \'shk_currency\', $currency_name );
        
    break;
    case \'OnSHKgetProductAdditParamPrice\':
    case \'OnSHKgetDeliveryPrice\':
    case \'OnSHKgetProductPrice\':

        if( !empty( $modx->event->returnedValues ) ){//Get from previous plugin
            $output = end( $modx->event->returnedValues );
        } else {
            $output = $modx->getOption( \'price\', $scriptProperties, 0 );
        }
        
        if( is_numeric( $output ) ){
            
            //Считаем цену по курсу
            $output = shk_currency_calc( $scriptProperties, $output, $currency_id );
            
            $modx->event->_output = \'\';
            $modx->event->output( $output );
            
        }else{
            $modx->event->output( false );
        }
        
    break;
    
}

return \'\';',
      'locked' => 0,
      'properties' => NULL,
      'disabled' => 1,
      'moduleguid' => '',
      'static' => 0,
      'static_file' => '',
      'content' => '/*
 plugin shk_multicurrency
 System event: OnLoadWebDocument, OnSHKgetProductPrice, OnSHKgetProductAdditParamPrice, OnSHKgetDeliveryPrice

<div>
    Валюта:
    <select id="site_currency" name="curency">
        <option value="1">руб.</option>
        <option value="2">грн.</option>
        <option value="3">USD</option>
        <option value="4">euro</option>
    </select>
</div>

*/

$scriptProperties = array_merge(
    array(
        \'currency_default\' => $modx->getOption( \'shk3.currency_default\', null, 1 ),
        \'currency_selected\' => $modx->getOption( \'shk3.currency_selected\', null, 0 )
    ),
    $scriptProperties
);

$shk_currency = !empty($_COOKIE[\'shk_currency\']) && is_numeric($_COOKIE[\'shk_currency\'])
    ? abs(intval($_COOKIE[\'shk_currency\']))
    : $scriptProperties[\'currency_default\'];
//Если нужен всегда преевод в одну валюту
if( !empty( $scriptProperties[\'currency_selected\'] ) && $shk_currency != $scriptProperties[\'currency_selected\'] ){
    setcookie( \'shk_currency\', intval($scriptProperties[\'currency_selected\']), time()+3600*24, "/" );
    $shk_currency = intval($scriptProperties[\'currency_selected\']);
}
$currency_id = isset($_GET[\'scurr\']) && is_numeric($_GET[\'scurr\']) ? intval($_GET[\'scurr\']) : $shk_currency;

if(!function_exists(\'shk_currency_calc\')){
    function shk_currency_calc($properties, $base_price, $currency_id, $rate_ratio = 0){
        
        $inverse = isset($properties[\'inverse\']) ? $properties[\'inverse\'] : false;//обратный перевод цены
        
        if( !$rate_ratio ){
            
            if( isset( $_SESSION[\'shk_curr_rate\'] ) && is_numeric( $_SESSION[\'shk_curr_rate\'] ) && !$inverse ){
                
                $rate_ratio = $_SESSION[\'shk_curr_rate\'];
                
            }else{
                
                if( !isset( $properties[\'currency_rate\'] ) ){
                    require_once MODX_CORE_PATH . "components/shopkeeper3/model/shopkeeper.class.php";
                    $config = Shopkeeper::getConfig( array(\'currency_rate\') );
                    $properties[\'currency_rate\'] = $config[\'currency_rate\'];
                }
                
                $rate_ratio = 1;
                
                if( $properties[\'currency_default\'] != $currency_id ){
                    
                    $rate_default = 1;
                    $rate = 1;
                    //Определяем курс по умолчанию и новый курс
                    foreach( $properties[\'currency_rate\'] as $rt ){
                        if( $rt[\'id\'] == $properties[\'currency_default\'] ){
                            $rate_default = Shopkeeper::cleanNumber( $rt[\'value\'], \'float\' );
                        }
                        else if( $rt[\'id\'] == $currency_id ){
                            $rate = Shopkeeper::cleanNumber( $rt[\'value\'], \'float\' );
                        }
                    }
                    
                    if( !$inverse ){
                        $rate_ratio = $rate_default / $rate;
                        $_SESSION[\'shk_curr_rate\'] = $rate_ratio;
                    }else{
                        $rate_ratio = $rate / $rate_default;
                    }
                    
                }
                
            }
            
        }
        
        //Считаем цену по курсу
        if( $rate_ratio ){
            
            $price = $base_price * $rate_ratio;
            $price = round( $price, ( ceil( $price ) == $price ? 0 : 2 ) );
            return $price;
        
        }else{
            return $base_price;
        }
        
    }
}

switch($modx->event->name){
    
    case \'OnLoadWebDocument\':
        
        if( !empty( $modx->placeholders[\'shk_currency\'] ) ) return \'\';
        
        if(empty($scriptProperties[\'noScript\'])){
            
            $script_str = \'
            <script type="text/javascript">
                var shk_cindex = document.cookie.indexOf("shk_currency=") > -1 ? document.cookie.indexOf("shk_currency=") + new String("shk_currency=").length : -1;
                var shk_currency = shk_cindex > -1 ? document.cookie.substring(shk_cindex,shk_cindex+1) : 1;
                jQuery("#site_currency")
                .val(shk_currency)
                .on("change",function(){
                    var loc_href = window.location.pathname+document.location.search;
                    window.location.href = loc_href+(loc_href.indexOf("?") > -1 ? "&" : "?") + "scurr=" + this.value;
                });
            </script>
            \';
            $modx->regClientScript( $script_str, true );
        }
        
        if( isset( $_GET[\'scurr\'] ) ){
            
            if( $currency_id != $shk_currency ){
                
                require_once MODX_CORE_PATH . "components/shopkeeper3/model/shopkeeper.class.php";
                
                $config = Shopkeeper::getConfig( array( \'currency_rate\', \'delivery\' ) );
                $scriptProperties[\'currency_rate\'] = $config[\'currency_rate\'];
                $conf_delivery = $config[\'delivery\'];
                
            }
            
            $_SESSION[\'shk_curr_rate\'] = null;
            unset($_SESSION[\'shk_curr_rate\']);
            
            //Доставка
            if( !empty( $conf_delivery ) ){
                
                $delivery_label = !empty( $_SESSION[\'shk_delivery\'][\'label\'] ) ? $_SESSION[\'shk_delivery\'][\'label\'] : \'\';
                $delivery_price = !empty( $_SESSION[\'shk_delivery\'][\'price\'] ) ? $_SESSION[\'shk_delivery\'][\'price\'] : 0;
                $_SESSION[\'shk_delivery\'] = array();
                
                foreach( $conf_delivery as $opt ){
                    
                    if( $opt[\'label\'] == $delivery_label ){
                        
                        $_SESSION[\'shk_delivery\'] = array(
                            \'label\' => $opt[\'label\'],
                            \'price\' => $delivery_price > 0 ? Shopkeeper::cleanNumber( $opt[\'price\'], \'float\' ) : 0,
                            \'old_price\' => Shopkeeper::cleanNumber( $opt[\'price\'], \'float\' ),
                            \'free_start\' => Shopkeeper::cleanNumber( $opt[\'free_start\'], \'float\' ),
                            \'old_free_start\' => Shopkeeper::cleanNumber( $opt[\'free_start\'], \'float\' )
                        );
                        
                        break;
                    }
                    
                }
                
                if( !empty( $_SESSION[\'shk_delivery\'][\'price\'] ) ){
                    $_SESSION[\'shk_delivery\'][\'price\'] = shk_currency_calc( $scriptProperties, $_SESSION[\'shk_delivery\'][\'price\'], $currency_id );
                }
                if( !empty( $_SESSION[\'shk_delivery\'][\'old_price\'] ) ){
                    $_SESSION[\'shk_delivery\'][\'old_price\'] = shk_currency_calc( $scriptProperties, $_SESSION[\'shk_delivery\'][\'old_price\'], $currency_id );
                }
                if( !empty( $_SESSION[\'shk_delivery\'][\'free_start\'] ) ){
                    $_SESSION[\'shk_delivery\'][\'free_start\'] = shk_currency_calc( $scriptProperties, $_SESSION[\'shk_delivery\'][\'free_start\'], $currency_id );
                    $_SESSION[\'shk_delivery\'][\'old_free_start\'] = $_SESSION[\'shk_delivery\'][\'free_start\'];
                }
                
            }
            
            $purchases = !empty( $_SESSION[\'shk_order\'] ) ? $_SESSION[\'shk_order\'] : array();
            
            if( !empty( $scriptProperties[\'currency_rate\'] ) ){
                
                //Изменяем цены товаров в корзине
                if( !empty( $purchases ) ){
                    
                    foreach( $purchases as $key => &$purchase ){
                        
                        if( isset( $purchase[\'old_price\'] ) ){
                            $base_price = $purchase[\'old_price\'];
                        }
                        else if( !isset( $purchase[\'old_price\'] ) ) {
                            $purchase[\'old_price\'] = $purchase[\'price\'];
                            $base_price = $purchase[\'price\'];
                        }
                        
                        $purchase[\'price\'] = shk_currency_calc( $scriptProperties, $base_price, $currency_id );
                        
                        //Доп. параметры
                        if( !empty( $purchase[\'options\'] ) ){
                            foreach( $purchase[\'options\'] as &$addit_param ){
                                
                                if( !isset( $addit_param[3] ) ) $addit_param[3] = $addit_param[1];
                                $addit_param[1] = shk_currency_calc( $scriptProperties, $addit_param[3], $currency_id );
                                
                            }
                        }
                        
                    }
                    
                    $_SESSION[\'shk_order\'] = $purchases;
                    
                }else{
                    
                    //Если нет товаров, просто переключаем валюту
                    shk_currency_calc( $scriptProperties, 0, $currency_id );
                    
                }
                
                $shk_currency = $currency_id;
                setcookie( \'shk_currency\', $shk_currency, time()+3600*24, "/" );
                
                //Сохраняем название валюты
                $currency_name = \'\';
                foreach( $scriptProperties[\'currency_rate\'] as $rt ){
                    if( $rt[\'id\'] == $currency_id ){
                        $currency_name = $rt[\'label\'];
                        break;
                    }
                }
                $_SESSION[\'shk_currency_name\'] = $currency_name;
                
            }
            
            $back_url = !empty($_SERVER[\'HTTP_REFERER\']) ? $_SERVER[\'HTTP_REFERER\'] : $modx->makeURL($modx->resource->get(\'parent\'),\'\',\'\',\'abs\');
            if( $modx->config[\'friendly_urls\'] ){
                if( strpos($back_url,\'?\') !== false ) $back_url = substr( $back_url, 0, strpos($back_url,\'?\') );
            }
            
            $modx->sendRedirect( $back_url, 0 );
            
        }
        
        $currency_name = !empty($_SESSION[\'shk_currency_name\']) ? $_SESSION[\'shk_currency_name\'] : \'\';
        if( !$currency_name ){
            $currency_name = $modx->getOption(\'shk3.currency\',null,\'\');
        }
        $modx->setPlaceholder( \'shk_currency\', $currency_name );
        
    break;
    case \'OnSHKgetProductAdditParamPrice\':
    case \'OnSHKgetDeliveryPrice\':
    case \'OnSHKgetProductPrice\':

        if( !empty( $modx->event->returnedValues ) ){//Get from previous plugin
            $output = end( $modx->event->returnedValues );
        } else {
            $output = $modx->getOption( \'price\', $scriptProperties, 0 );
        }
        
        if( is_numeric( $output ) ){
            
            //Считаем цену по курсу
            $output = shk_currency_calc( $scriptProperties, $output, $currency_id );
            
            $modx->event->_output = \'\';
            $modx->event->output( $output );
            
        }else{
            $modx->event->output( false );
        }
        
    break;
    
}

return \'\';',
    ),
  ),
  'f641a4d3d2009a8a125d18e279844261' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 9,
      'event' => 'OnLoadWebDocument',
    ),
    'object' => 
    array (
      'pluginid' => 9,
      'event' => 'OnLoadWebDocument',
      'priority' => 8,
      'propertyset' => 0,
    ),
  ),
  'd33e40531d1b8e0a145829fb8f52c50d' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 9,
      'event' => 'OnSHKgetProductPrice',
    ),
    'object' => 
    array (
      'pluginid' => 9,
      'event' => 'OnSHKgetProductPrice',
      'priority' => 9,
      'propertyset' => 0,
    ),
  ),
  '2eaa4a7ef4fc94d9e5bb43d26c915391' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 9,
      'event' => 'OnSHKgetProductAdditParamPrice',
    ),
    'object' => 
    array (
      'pluginid' => 9,
      'event' => 'OnSHKgetProductAdditParamPrice',
      'priority' => 10,
      'propertyset' => 0,
    ),
  ),
  '25e1a4315d68066cd987ebf41d61c6e0' => 
  array (
    'criteria' => 
    array (
      'pluginid' => 9,
      'event' => 'OnSHKgetDeliveryPrice',
    ),
    'object' => 
    array (
      'pluginid' => 9,
      'event' => 'OnSHKgetDeliveryPrice',
      'priority' => 11,
      'propertyset' => 0,
    ),
  ),
);